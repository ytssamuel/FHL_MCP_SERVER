"""
FHL Bible MCP Server - Reading Passage Prompt

段落讀經輔助，針對跨章節經文段落的深入研讀
"""

from ..base import PromptTemplate


class ReadingPassagePrompt(PromptTemplate):
    """讀經 - 段落讀經輔助 Prompt"""
    
    def __init__(self):
        super().__init__(
            name="reading_passage",
            description="閱讀和分析一段經文（可能跨越多個章節），包含背景、主題、解經和應用",
            arguments=[
                {
                    "name": "book",
                    "description": "經卷名稱（中文或英文）",
                    "required": True
                },
                {
                    "name": "start_chapter",
                    "description": "起始章",
                    "required": True
                },
                {
                    "name": "start_verse",
                    "description": "起始節",
                    "required": True
                },
                {
                    "name": "end_chapter",
                    "description": "結束章",
                    "required": True
                },
                {
                    "name": "end_verse",
                    "description": "結束節",
                    "required": True
                },
                {
                    "name": "version",
                    "description": "聖經版本代碼（預設：unv）",
                    "required": False
                }
            ]
        )
    
    def render(
        self,
        book: str = "約翰福音",
        start_chapter: int = 3,
        start_verse: int = 1,
        end_chapter: int = 3,
        end_verse: int = 21,
        version: str = "unv"
    ) -> str:
        """渲染段落讀經的 prompt"""
        passage_ref = f"{book} {start_chapter}:{start_verse}-{end_chapter}:{end_verse}"
        is_cross_chapter = start_chapter != end_chapter
        
        return f"""# 段落讀經 - {passage_ref}

歡迎來到段落讀經！讓我們深入探索這段重要的經文。

【經文資訊】
• 經卷：{book}
• 範圍：{start_chapter}:{start_verse} - {end_chapter}:{end_verse}
• 版本：{version.upper()}
• 跨章節：{'是' if start_chapter != end_chapter else '否'}

═══════════════════════════════════════════════════════════════════
步驟 1：段落獲取 📚
═══════════════════════════════════════════════════════════════════

首先，讓我們取得這段經文的完整內容。

【獲取經文】：

{self._render_fetch_commands(book, start_chapter, start_verse, end_chapter, end_verse, version)}

【初步閱讀】：

請先閱讀 2-3 遍，每次注意不同重點：

🔍 **第一遍 - 整體印象**：
   • 這段經文在講什麼？
   • 有什麼人物、地點或事件？
   • 整體的情緒氛圍是什麼？

🔍 **第二遍 - 細節觀察**：
   • 有哪些關鍵字詞反覆出現？
   • 有什麼對比或漸進的關係？
   • 作者的寫作手法是什麼？

🔍 **第三遍 - 結構分析**：
   • 這段如何開始和結束？
   • 中間的論證或敘事如何發展？
   • 有沒有轉折或高潮？

═══════════════════════════════════════════════════════════════════
步驟 2：段落背景 📜
═══════════════════════════════════════════════════════════════════

了解這段經文的背景脈絡，幫助我們正確理解其意義。

【上下文連結】：

🔼 **前文（{start_chapter}:{start_verse} 之前）**：
   • 這段之前發生了什麼？
   • 有什麼鋪墊或伏筆？
   • 建議閱讀：{book} {max(1, start_chapter-1)} 章

🔽 **後文（{end_chapter}:{end_verse} 之後）**：
   • 這段之後會發生什麼？
   • 有什麼延續或回應？
   • 建議閱讀：{book} {end_chapter+1} 章

【書卷脈絡】：

這段經文在全書中的位置：

• 📖 書卷主題：________________
• 📍 段落位置：全書的 ______ 部分
• 🎯 段落角色：________________
  □ 引言開場
  □ 主體論述
  □ 高潮轉折
  □ 結論收尾
  □ 獨立單元

【查看書卷資訊】：
```
# 了解書卷背景
info://books

# 查看前後章節
get_bible_chapter(book="{book}", chapter={start_chapter-1 if start_chapter > 1 else 1}, version="{version}")
get_bible_chapter(book="{book}", chapter={end_chapter+1}, version="{version}")
```

【歷史文化背景】：

💡 **歷史處境**：
   • 寫作時間：________________
   • 歷史事件：________________
   • 社會狀況：________________

💡 **文化背景**：
   • 風俗習慣：________________
   • 宗教傳統：________________
   • 生活方式：________________

💡 **寫作目的**：
   • 原本讀者：________________
   • 面對問題：________________
   • 作者意圖：________________

═══════════════════════════════════════════════════════════════════
步驟 3：主題識別 🎯
═══════════════════════════════════════════════════════════════════

識別這段經文的核心主題和次要主題。

【主要主題】：

這段經文的中心主題是什麼？

主題：________________

支持證據：
• 第 ___:___ - ________________
• 第 ___:___ - ________________
• 第 ___:___ - ________________

【次要主題】：

還有哪些重要但次要的主題？

1. 主題 1：________________
   • 相關經文：第 ___:___
   • 簡要說明：________________

2. 主題 2：________________
   • 相關經文：第 ___:___
   • 簡要說明：________________

3. 主題 3：________________
   • 相關經文：第 ___:___
   • 簡要說明：________________

【主題搜尋】：

尋找聖經中其他論述相同主題的經文：

```
# 搜尋主題相關經文
search_bible(keyword="[主題關鍵字]", version="{version}", limit=10)
```

【主題經文串連】：

📌 **舊約中的論述**：
   • _______ ___:___ - ________________
   • _______ ___:___ - ________________

📌 **新約中的論述**：
   • _______ ___:___ - ________________
   • _______ ___:___ - ________________

📌 **與本段的關聯**：
   • 如何彼此呼應？________________
   • 如何互補說明？________________
   • 如何漸進發展？________________

═══════════════════════════════════════════════════════════════════
步驟 4：重點經節 ⭐
═══════════════════════════════════════════════════════════════════

找出這段經文中最關鍵的 3-5 節，深入分析。

【關鍵經節選擇標準】：
• 包含核心真理或命令
• 是整段的轉折點
• 特別觸動人心
• 神學意義重大
• 實際應用性強

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【關鍵經節 1】{book} ___:___
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📖 **經文內容**：
「________________」

🔍 **為何重要**：
• ________________
• ________________

📚 **原文分析**：

使用工具深入了解關鍵字：
```
get_word_analysis(book="{book}", chapter=___, verse=___, version="{version}")
```

重要字詞：
• [字詞 1]：原文 ______，意思是 ________________
• [字詞 2]：原文 ______，意思是 ________________

🔗 **相關經文**：
• _______ ___:___ - ________________
• _______ ___:___ - ________________

💭 **個人反思**：
• 這節對我說了什麼？________________
• 我如何回應？________________

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【關鍵經節 2】{book} ___:___
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

（重複以上框架）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【關鍵經節 3】{book} ___:___
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

（重複以上框架）

【Strong's 研究】：

針對重要的原文字：
```
# 查詢 Strong's 字典
lookup_strongs(testament="nt/ot", strongs_number="___")

# 查看這字在聖經中的其他出現
search_strongs_occurrences(testament="nt/ot", strongs_number="___", limit=10)
```

═══════════════════════════════════════════════════════════════════
步驟 5：結構大綱 📐
═══════════════════════════════════════════════════════════════════

分析這段經文的邏輯結構和論證流程。

【文學體裁】：

這段屬於哪種文學體裁？

□ 敘事（Narrative）
□ 詩歌（Poetry）  
□ 律法（Law）
□ 智慧（Wisdom）
□ 預言（Prophecy）
□ 書信（Epistle）
□ 啟示（Apocalyptic）

體裁特徵：________________

【段落結構】：

將這段經文分成小單元：

```
{passage_ref} - 結構大綱

I. 開場/引言（___:___-___）
   主旨：________________
   
   A. ________________（___:___）
   B. ________________（___:___）

II. 主體/發展（___:___-___）
    主旨：________________
    
    A. 第一重點（___:___-___）
       1. ________________
       2. ________________
    
    B. 第二重點（___:___-___）
       1. ________________
       2. ________________
    
    C. 第三重點（___:___-___）
       1. ________________
       2. ________________

III. 高潮/轉折（___:___-___）
     主旨：________________
     
     A. ________________（___:___）
     B. ________________（___:___）

IV. 結論/應用（___:___-___）
    主旨：________________
    
    A. ________________（___:___）
    B. ________________（___:___）
```

【論證流程】（如果是說理文）：

• 前提：________________
• 論證：________________
• 結論：________________

【敘事發展】（如果是敘事文）：

• 背景設定：________________
• 衝突出現：________________
• 情節發展：________________
• 高潮轉折：________________
• 結局收尾：________________

【修辭手法】：

作者使用了哪些修辭技巧？

□ 比喻/明喻
□ 對比/對偶
□ 漸進/高潮
□ 重複/迴環
□ 反問/設問
□ 誇飾/強調

例如：________________

═══════════════════════════════════════════════════════════════════
步驟 6：解經要點 💡
═══════════════════════════════════════════════════════════════════

深入解釋這段經文的意義，參考註釋和其他資源。

【查看註釋】：
```
# 查看註釋
get_commentary(book="{book}", chapter={start_chapter}, verse={start_verse})

# 搜尋相關註釋
search_commentary(keyword="[關鍵字]", limit=5)

# 查看可用註釋書
list_commentaries()
```

【釋經原則】：

📖 **字面意義（Literal Sense）**：
   經文的字面意思是什麼？
   • ________________

📖 **歷史意義（Historical Sense）**：
   對原本讀者的意義是什麼？
   • ________________

📖 **神學意義（Theological Sense）**：
   關於神、人、救恩的真理是什麼？
   • ________________

📖 **實踐意義（Practical Sense）**：
   對今天的信徒意味著什麼？
   • ________________

【難解經文】：

這段有哪些難以理解的地方？

❓ **難題 1**：第 ___:___ 節
   • 困難點：________________
   • 可能解釋：
     - 解釋 A：________________
     - 解釋 B：________________
   • 採納觀點：________________
   • 理由：________________

❓ **難題 2**：第 ___:___ 節
   • 困難點：________________
   • 可能解釋：
     - 解釋 A：________________
     - 解釋 B：________________
   • 採納觀點：________________
   • 理由：________________

【神學主題】：

🕊️ **關於神**：
   這段揭示了神的什麼屬性或作為？
   • ________________
   • ________________

👤 **關於人**：
   這段揭示了人的什麼本質或處境？
   • ________________
   • ________________

✝️ **關於基督**：
   這段如何指向或彰顯基督？
   • ________________
   • ________________

⛪ **關於教會**：
   這段對教會有什麼教導或應用？
   • ________________
   • ________________

🌍 **關於末世**：
   這段是否涉及末世或永恆？
   • ________________
   • ________________

═══════════════════════════════════════════════════════════════════
步驟 7：神學反思 🙏
═══════════════════════════════════════════════════════════════════

從神學角度深入思考這段經文的意義。

【救恩歷史中的位置】：

這段經文在救恩歷史中扮演什麼角色？

📜 **舊約時期**（如果適用）：
   • 與創造的關係：________________
   • 與墮落的關係：________________
   • 與應許的關係：________________
   • 與律法的關係：________________
   • 與先知的關係：________________

✝️ **新約時期**（如果適用）：
   • 與道成肉身的關係：________________
   • 與十字架的關係：________________
   • 與復活的關係：________________
   • 與聖靈的關係：________________
   • 與教會的關係：________________

⏰ **末世時期**：
   • 對現今教會的意義：________________
   • 對將來盼望的指向：________________

【核心教義】：

這段經文與哪些基要教義相關？

□ 三位一體
□ 基督論
□ 救恩論
□ 教會論
□ 末世論
□ 聖經論
□ 人論
□ 罪論

說明：________________

【福音信息】：

這段如何顯明或應用福音？

罪 → 赦 → 恩 → 信 → 愛

• **罪的診斷**：________________
• **赦免的需要**：________________
• **恩典的供應**：________________
• **信心的回應**：________________
• **愛的實踐**：________________

【屬靈操練】：

這段經文引導我們進行哪些屬靈操練？

□ 禱告
□ 讀經
□ 敬拜
□ 禁食
□ 默想
□ 服事
□ 施捨
□ 團契
□ 見證

具體說明：________________

═══════════════════════════════════════════════════════════════════
步驟 8：實際應用 🌟
═══════════════════════════════════════════════════════════════════

將經文的真理轉化為生活中的具體行動。

【應用原則】：

從解釋到應用的橋樑：

1. **永恆真理**：
   這段經文的永恆不變真理是什麼？
   • ________________

2. **文化差異**：
   原本的文化處境與今天有什麼不同？
   • ________________

3. **相似處境**：
   今天有哪些類似的處境？
   • ________________

4. **應用方向**：
   真理如何應用在今天的處境中？
   • ________________

【生命檢視】：

對照這段經文，檢視自己的生命：

💭 **信仰層面**：
   • 我對神的認識是否正確？________________
   • 我的信心是否堅固？________________
   • 我是否相信神的應許？________________

💭 **品格層面**：
   • 我需要培養什麼美德？________________
   • 我需要除去什麼惡習？________________
   • 我需要改變什麼態度？________________

💭 **關係層面**：
   • 與神的關係：________________
   • 與家人的關係：________________
   • 與弟兄姊妹的關係：________________
   • 與非信徒的關係：________________

💭 **服事層面**：
   • 我當如何事奉神？________________
   • 我當如何服事人？________________
   • 我當如何使用恩賜？________________

【具體行動】：

本週的 SMART 行動計畫：

📋 **行動 1**：
   • Specific（具體）：________________
   • Measurable（可衡量）：________________
   • Achievable（可實現）：________________
   • Relevant（相關）：________________
   • Time-bound（有時限）：________________

📋 **行動 2**：
   • Specific（具體）：________________
   • Measurable（可衡量）：________________
   • Achievable（可實現）：________________
   • Relevant（相關）：________________
   • Time-bound（有時限）：________________

【問責夥伴】：

• 與誰分享這個領受？________________
• 如何彼此問責？________________
• 何時檢視進度？________________

【禱告回應】：

根據這段經文，寫下你的禱告：

```
親愛的天父：

感謝祢透過《{book}》{start_chapter}:{start_verse}-{end_chapter}:{end_verse} 向我說話...

（根據你的領受，包括敬拜、認罪、感恩、祈求）

求祢幫助我...

奉主耶穌基督的名禱告，阿們。
```

═══════════════════════════════════════════════════════════════════
📊 研讀總結
═══════════════════════════════════════════════════════════════════

【一句話總結】：
這段經文的核心信息：「________________」

【三個要點】：
1. ________________
2. ________________
3. ________________

【金句】：
{book} ___:___
「________________」

【應用】：
本週我要：________________

═══════════════════════════════════════════════════════════════════
🎯 延伸研讀建議
═══════════════════════════════════════════════════════════════════

【深入研經】：
• 使用 `study_verse_deep` 深入研讀關鍵經節
• 使用 `study_topic_deep` 研究相關主題
• 使用 `study_translation_compare` 比較不同譯本
• 使用 `study_word_original` 研究原文字詞

【相關段落】：
• 前一段：{book} {max(1, start_chapter-1)}章
• 後一段：{book} {end_chapter+1}章
• 平行經文：________________

【主題查經】：
```
# 搜尋相關主題
search_bible(keyword="[主題]", version="{version}", limit=15)
```

【小組討論】：
這段經文適合小組討論，可以分享：
• 各人不同的領受
• 具體的應用例子
• 彼此的代禱事項

═══════════════════════════════════════════════════════════════════

📖 願神的話語照亮你的心！
💡 願聖靈引導你進入真理！
🙏 願你在基督裡不斷成長！

═══════════════════════════════════════════════════════════════════
"""
    
    def _format_passage_reference(
        self,
        book: str,
        start_chapter: int,
        start_verse: int,
        end_chapter: int,
        end_verse: int
    ) -> str:
        """格式化經文引用"""
        if start_chapter == end_chapter:
            return f"{book} {start_chapter}:{start_verse}-{end_verse}"
        else:
            return f"{book} {start_chapter}:{start_verse} - {end_chapter}:{end_verse}"
    
    def _render_fetch_commands(
        self,
        book: str,
        start_chapter: int,
        start_verse: int,
        end_chapter: int,
        end_verse: int,
        version: str
    ) -> str:
        """渲染獲取經文的命令"""
        if start_chapter == end_chapter:
            # 同一章內的段落
            return f"""```
# 方式 1：使用 get_bible_verse 獲取範圍經文
get_bible_verse(
    book="{book}",
    chapter={start_chapter},
    verse={start_verse},
    end_verse={end_verse},
    version="{version}"
)

# 方式 2：如果需要看更多上下文，獲取整章
get_bible_chapter(book="{book}", chapter={start_chapter}, version="{version}")
# 然後重點關注第 {start_verse}-{end_verse} 節
```"""
        else:
            # 跨章節的段落
            return f"""```
# 跨章節段落，需要分別獲取

# 第一部分：{book} {start_chapter}:{start_verse} 到章末
get_bible_verse(
    book="{book}",
    chapter={start_chapter},
    verse={start_verse},
    version="{version}"
)

{self._render_middle_chapters(book, start_chapter, end_chapter, version)}

# 最後部分：{book} {end_chapter}:1-{end_verse}
get_bible_verse(
    book="{book}",
    chapter={end_chapter},
    verse=1,
    end_verse={end_verse},
    version="{version}"
)

# 或者，也可以逐章獲取完整內容
{"".join(f'''
get_bible_chapter(book="{book}", chapter={ch}, version="{version}")''' 
for ch in range(start_chapter, end_chapter + 1))}
```"""
    
    def _render_middle_chapters(
        self,
        book: str,
        start_chapter: int,
        end_chapter: int,
        version: str
    ) -> str:
        """渲染中間章節的命令"""
        if end_chapter - start_chapter <= 1:
            return ""
        
        commands = []
        for ch in range(start_chapter + 1, end_chapter):
            commands.append(f"""
# 中間章節：{book} {ch} 章（完整）
get_bible_chapter(book="{book}", chapter={ch}, version="{version}")""")
        
        return "".join(commands)

