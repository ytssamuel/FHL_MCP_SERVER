"""
FHL Bible MCP Server - Daily Reading Prompt

每日讀經計劃輔助，提供結構化的讀經體驗
"""

from ..base import PromptTemplate


class ReadingDailyPrompt(PromptTemplate):
    """讀經 - 每日讀經計劃 Prompt"""
    
    def __init__(self):
        super().__init__(
            name="reading_daily",
            description="引導進行每日讀經，包含經文、默想和應用，提供完整的靈修體驗",
            arguments=[
                {
                    "name": "reading_plan",
                    "description": "讀經計劃類型 (sequential/random/topic/verse_of_day)",
                    "required": False
                },
                {
                    "name": "book",
                    "description": "指定書卷（如果選擇 sequential 或 topic）",
                    "required": False
                },
                {
                    "name": "chapter",
                    "description": "指定章節（如果選擇 sequential）",
                    "required": False
                },
                {
                    "name": "version",
                    "description": "聖經版本代碼（預設：unv）",
                    "required": False
                }
            ]
        )
    
    def render(
        self,
        reading_plan: str = "verse_of_day",
        book: str = None,
        chapter: int = None,
        version: str = "unv"
    ) -> str:
        """
        渲染每日讀經的 prompt
        
        Args:
            reading_plan: 讀經計劃類型
            book: 書卷名稱
            chapter: 章節數
            version: 聖經版本
            
        Returns:
            渲染後的 prompt
        """
        return f"""
═══════════════════════════════════════════════════════════════════
📖 每日讀經 - Daily Bible Reading
═══════════════════════════════════════════════════════════════════

歡迎來到今天的讀經時間！讓我們一起透過神的話語，領受屬天的智慧和力量。

【讀經計劃】：{self._get_plan_name(reading_plan)}
【聖經版本】：{version.upper()}
{self._get_plan_details(reading_plan, book, chapter)}

═══════════════════════════════════════════════════════════════════
步驟 1：選擇今日經文 📚
═══════════════════════════════════════════════════════════════════

{self._render_scripture_selection(reading_plan, book, chapter)}

請執行以下操作來獲取經文：

{self._get_scripture_tool_command(reading_plan, book, chapter, version)}

═══════════════════════════════════════════════════════════════════
步驟 2：閱讀經文 📖
═══════════════════════════════════════════════════════════════════

【閱讀提示】：
• 安靜心靈：找一個安靜的地方，預備心來親近神
• 禱告開始：求聖靈光照，幫助你明白神的話語
• 慢讀細想：不要匆忙，讓經文在心中停留
• 重複閱讀：至少讀 2-3 遍，每次注意不同細節

【閱讀方式選擇】：
• 默讀：安靜閱讀，細細品味
• 朗讀：大聲讀出，耳朵聽見神的話
• 音訊：使用 `get_audio_chapter_with_text` 聆聽朗讀版本

═══════════════════════════════════════════════════════════════════
步驟 3：背景介紹 📜
═══════════════════════════════════════════════════════════════════

{self._render_background_intro(reading_plan, book)}

【使用工具】：
• 查看書卷資訊：使用 `info://books?testament=NT` 或 `OT`
• 查看更多經文：使用 `get_bible_chapter` 了解上下文

═══════════════════════════════════════════════════════════════════
步驟 4：重點提示 💡
═══════════════════════════════════════════════════════════════════

在閱讀經文時，請特別注意以下要點：

【觀察問題】（What - 這段經文說什麼？）：
1. 📌 主要人物：這段經文提到誰？他們在做什麼？
2. 📌 關鍵字詞：有哪些字詞反覆出現或特別突出？
3. 📌 重要事件：發生了什麼事？有什麼轉折或高潮？
4. 📌 情感氛圍：作者或人物的情緒是什麼？
5. 📌 文學特色：是敘事、詩歌、書信、預言？

【理解問題】（Why - 為什麼這樣說？）：
1. 🤔 歷史背景：當時發生了什麼事？
2. 🤔 文化脈絡：這對原本的讀者意味著什麼？
3. 🤔 神學意義：這段經文揭示神的什麼屬性？
4. 🤔 邏輯連貫：這段如何連接前後文？

【工具輔助】：
• 原文查詢：使用 `get_word_analysis` 查看關鍵字的原文意義
• 交叉引用：使用 `search_bible` 找相關經文
• 註釋參考：使用 `get_commentary` 查看解經註釋

═══════════════════════════════════════════════════════════════════
步驟 5：默想問題 🤲
═══════════════════════════════════════════════════════════════════

靜下心來，思想以下問題：

【個人反思】：
1. 💭 神透過這段經文，對我說了什麼？
   - 有什麼真理是我以前沒注意到的？
   - 有什麼提醒、安慰或挑戰？

2. 💭 我從這段經文中，認識到神的哪些屬性？
   - 神的愛、公義、信實、智慧...？
   - 這如何影響我對神的認識？

3. 💭 我的生命中有哪些地方需要改變？
   - 有什麼罪需要悔改？
   - 有什麼真理需要更深相信？
   - 有什麼美德需要追求？

【生活連結】：
4. 💭 這段經文與我當前的處境有什麼關聯？
   - 我正面臨什麼挑戰或困惑？
   - 這段經文如何回應我的需要？

5. 💭 我可以如何回應神的話語？
   - 今天我可以做什麼具體行動？
   - 我需要向誰分享這段經文？

【記錄方式】：
• 寫在靈修日記中
• 使用 Highlight 功能標記重點
• 在筆記本上畫出心得圖

═══════════════════════════════════════════════════════════════════
步驟 6：生活應用 🌟
═══════════════════════════════════════════════════════════════════

讀經的目的不只是知道，更要活出來。請思考具體的應用：

【SMART 應用原則】：

📍 Specific（具體的）：
   - 不要只說「我要更愛人」
   - 而是「今天我要主動關心同事小王，問候他的近況」

⏰ Measurable（可衡量的）：
   - 設定明確的指標
   - 例如：「每天讀經 15 分鐘」而非「多讀聖經」

🎯 Achievable（可實現的）：
   - 從小事開始，不要好高騖遠
   - 今天可以做的一件事

⚡ Relevant（相關的）：
   - 與今天讀的經文直接相關
   - 針對聖靈光照的部分回應

📅 Time-bound（有時限的）：
   - 設定時間：今天、本週、本月
   - 例如：「今天下午我要...」

【行動建議】：
根據今天的經文，選擇 1-2 個具體行動：

□ 關係方面：
  - 向某人道歉、和好
  - 鼓勵、感謝某人
  - 主動關心某人

□ 態度方面：
  - 放下某個擔憂或恐懼
  - 改變某個負面想法
  - 培養某個美德

□ 行為方面：
  - 停止某個壞習慣
  - 開始某個好習慣
  - 完成某個被拖延的事

□ 靈性方面：
  - 為某事禱告
  - 與某人分享信仰
  - 參加團契或服事

═══════════════════════════════════════════════════════════════════
步驟 7：禱告方向 🙏
═══════════════════════════════════════════════════════════════════

讓我們以禱告來回應神的話語：

【ACTS 禱告架構】：

🌟 Adoration（敬拜讚美）：
   根據今天經文中神的屬性來讚美祂
   例如：「天父，我讚美祢是信實的神...」

😔 Confession（認罪悔改）：
   為經文光照出的罪認罪
   例如：「主啊，我承認我...求祢赦免我...」

🙏 Thanksgiving（感恩）：
   為神的話語和恩典感謝
   例如：「主，我感謝祢今天透過這段經文提醒我...」

💬 Supplication（祈求代禱）：
   • 個人需要：為今天的應用行動禱告
   • 他人需要：為家人、朋友、教會禱告
   • 世界需要：為國家、社會、宣教禱告

【禱告範例】：
```
親愛的天父：

（敬拜）感謝祢今天透過這段經文與我說話...

（認罪）我承認我在...方面虧欠了祢...

（感恩）我感謝祢的恩典，讓我知道...

（祈求）求祢幫助我今天能夠...

奉主耶穌基督的名禱告，阿們。
```

═══════════════════════════════════════════════════════════════════
💎 今日金句
═══════════════════════════════════════════════════════════════════

從今天的經文中，選擇一節特別觸動你的經文，作為今日金句：

📝 記錄方式：
   • 寫在卡片上，放在顯眼處
   • 設為手機桌布或提醒
   • 背誦並默想一整天

💡 應用建議：
   • 早晨醒來默想一次
   • 午間休息時重溫
   • 晚上睡前感謝神

═══════════════════════════════════════════════════════════════════
📊 讀經進度追蹤
═══════════════════════════════════════════════════════════════════

{self._render_progress_tracking(reading_plan)}

═══════════════════════════════════════════════════════════════════
🎯 明日讀經預告
═══════════════════════════════════════════════════════════════════

{self._render_tomorrow_preview(reading_plan, book, chapter)}

═══════════════════════════════════════════════════════════════════
💡 靈修小貼士
═══════════════════════════════════════════════════════════════════

• ⏰ 固定時間：每天同一時間讀經，養成習慣
• 📍 固定地點：選擇一個安靜、舒適的地方
• 📖 預備工具：聖經、筆記本、筆、禱告日記
• 🎧 善用資源：音訊聖經、讀經 App、靈修材料
• 👥 彼此勉勵：與屬靈夥伴分享心得、互相代禱
• 📅 持之以恆：即使忙碌，也堅持每天親近神

═══════════════════════════════════════════════════════════════════

願神的話語成為你腳前的燈、路上的光！
願聖靈引導你，使你在真理中得著自由和喜樂！

🙏 祝福你有美好的靈修時光！

═══════════════════════════════════════════════════════════════════
"""
    
    def _get_plan_name(self, plan: str) -> str:
        """獲取讀經計劃的中文名稱"""
        plans = {
            "sequential": "📚 順序讀經（按章節順序閱讀）",
            "random": "🎲 隨機讀經（由系統隨機選擇）",
            "topic": "🔍 主題讀經（按特定主題選擇）",
            "verse_of_day": "⭐ 今日金句（信望愛每日金句）"
        }
        return plans.get(plan, "⭐ 今日金句")
    
    def _get_plan_details(self, plan: str, book: str, chapter: int) -> str:
        """獲取讀經計劃的詳細資訊"""
        if plan == "sequential" and book:
            return f"【指定讀經】：{book}{f' 第 {chapter} 章' if chapter else ''}"
        elif plan == "topic" and book:
            return f"【主題書卷】：{book}"
        return ""
    
    def _render_scripture_selection(self, plan: str, book: str, chapter: int) -> str:
        """渲染經文選擇說明"""
        if plan == "verse_of_day":
            return """今天我們將使用「信望愛網站」的每日金句作為讀經內容。

【今日金句】：
這是信望愛聖經網站每日更新的金句，特別適合開始每日靈修。

【特色】：
• 每天不同的經文，保持新鮮感
• 精選的經文，都是寶貴的真理
• 簡短有力，適合背誦和默想"""
        
        elif plan == "sequential":
            if book and chapter:
                return f"""今天我們將閱讀《{book}》第 {chapter} 章。

【順序讀經】：
按照聖經書卷的章節順序，系統化地閱讀神的話語。

【好處】：
• 完整了解每卷書的脈絡
• 不會遺漏任何經文
• 養成規律讀經的習慣"""
            elif book:
                return f"""今天我們將開始閱讀《{book}》。

建議從第 1 章開始，按順序閱讀整卷書。"""
            else:
                return """請指定要閱讀的書卷和章節。

例如：book="約翰福音", chapter=1"""
        
        elif plan == "random":
            return """今天將隨機選擇一段經文。

【隨機讀經】：
讓聖靈引導，隨機選擇今天的經文。

【適合時機】：
• 想要新鮮感的時候
• 尋求特別引導時
• 打破讀經倦怠期"""
        
        elif plan == "topic":
            if book:
                return f"""今天我們將閱讀與「{book}」相關的主題經文。

【主題讀經】：
根據特定主題或書卷，深入了解聖經的教導。

【好處】：
• 全面了解某個主題
• 串連不同經文的教導
• 建立系統化的聖經知識"""
            else:
                return """請指定要研讀的主題。

例如：book="愛"、book="信心"、book="盼望" 等"""
        
        return "請選擇讀經計劃。"
    
    def _get_scripture_tool_command(self, plan: str, book: str, chapter: int, version: str) -> str:
        """獲取經文工具命令"""
        if plan == "verse_of_day":
            return f"""```
# 1. 獲取今日金句
get_verse_of_day()

# 2. 如果想閱讀完整章節，使用
get_bible_chapter(book="[今日金句的書卷]", chapter=[今日金句的章], version="{version}")
```"""
        
        elif plan == "sequential" and book:
            if chapter:
                return f"""```
# 閱讀指定章節
get_bible_chapter(book="{book}", chapter={chapter}, version="{version}")

# 如果需要音訊
get_audio_chapter_with_text(book="{book}", chapter={chapter}, version="{version}")
```"""
            else:
                return f"""```
# 從第一章開始
get_bible_chapter(book="{book}", chapter=1, version="{version}")
```"""
        
        elif plan == "random":
            return f"""```
# 先查看可用的書卷
list_bible_books()

# 然後隨機選擇一章（例如詩篇）
import random
chapter_num = random.randint(1, 150)  # 詩篇有150篇
get_bible_chapter(book="Psalms", chapter=chapter_num, version="{version}")
```"""
        
        elif plan == "topic" and book:
            return f"""```
# 搜尋主題相關經文
search_bible(keyword="{book}", version="{version}", limit=10)

# 閱讀特定經文
get_bible_verse(book="[書卷]", chapter=[章], verse=[節], version="{version}")
```"""
        
        return "```\nget_verse_of_day()\n```"
    
    def _render_background_intro(self, plan: str, book: str) -> str:
        """渲染背景介紹"""
        if book:
            return f"""讓我們了解《{book}》的背景：

【建議查詢】：
• 作者是誰？寫作時間？
• 寫作對象和目的？
• 書卷的主題和特色？
• 在聖經中的重要性？

這些資訊能幫助你更好地理解今天的經文。"""
        else:
            return """了解經文的背景非常重要：

【背景資訊包括】：
• 歷史背景：當時發生了什麼事？
• 文化背景：當時的風俗習慣？
• 寫作背景：為何寫這段經文？
• 神學背景：在救恩歷史中的位置？

這些幫助我們正確理解神的話語。"""
    
    def _render_progress_tracking(self, plan: str) -> str:
        """渲染進度追蹤"""
        if plan == "sequential":
            return """【順序讀經進度】：
• 今天完成：✅
• 本週進度：____ / 7 章
• 本月進度：____ / 30 章
• 年度目標：讀完整本聖經

💡 提示：可以使用讀經 App 或筆記本記錄進度"""
        
        elif plan == "verse_of_day":
            return """【每日金句進度】：
• 今天完成：✅
• 連續天數：____ 天
• 本月天數：____ / 30 天

💡 提示：保持連續讀經，培養美好習慣"""
        
        else:
            return """【讀經進度】：
• 今天完成：✅
• 本週讀經：____ / 7 天
• 本月讀經：____ / 30 天

💡 提示：堅持每日讀經，生命必然成長"""
    
    def _render_tomorrow_preview(self, plan: str, book: str, chapter: int) -> str:
        """渲染明日讀經預告"""
        if plan == "sequential" and book and chapter:
            next_chapter = chapter + 1
            return f"""明天將繼續閱讀《{book}》第 {next_chapter} 章。

【預習建議】：
• 今天可以先快速瀏覽明天的經文
• 思考它與今天讀的內容有什麼連貫性
• 預備心明天繼續親近神"""
        
        elif plan == "verse_of_day":
            return """明天將有新的每日金句。

【期待】：
• 每天都有新鮮的話語
• 神總有新的恩典和帶領
• 明天同一時間，我們再次相會"""
        
        else:
            return """明天繼續你的讀經計劃。

【勉勵】：
• 今天的領受，明天再反思
• 持續讀經，生命必然改變
• 神的話語永不落空"""

