"""主題串連 Prompt

串連聖經中同一主題的經文，呈現神學發展線。
"""

from typing import Optional
from ..base import PromptTemplate


class SpecialTopicalChainPrompt(PromptTemplate):
    """主題串連對話範本
    
    找出並串連聖經中關於特定主題的所有重要經文，
    展現從舊約到新約的神學發展脈絡。
    """
    
    def __init__(
        self,
        topic: str = "love",
        testament: str = "both",
        depth: str = "detailed",
        version: str = "unv"
    ):
        """初始化主題串連 Prompt
        
        Args:
            topic: 主題關鍵字（如 "love", "grace", "faith"，預設：love）
            testament: 約別範圍
                - OT: 僅舊約
                - NT: 僅新約
                - both: 新舊約都包含
            depth: 研究深度
                - overview: 概覽（5-10處經文）
                - detailed: 詳細（10-20處經文）
                - exhaustive: 詳盡（20+處經文）
            version: 聖經版本（預設：unv 和合本）
        """
        super().__init__(
            name="special_topical_chain",
            description="串連聖經中關於特定主題的所有重要經文",
            arguments=[
                {"name": "topic", "description": "主題關鍵字", "required": False},
                {"name": "testament", "description": "約別範圍 (OT/NT/both)", "required": False},
                {"name": "depth", "description": "研究深度 (overview/detailed/exhaustive)", "required": False},
                {"name": "version", "description": "聖經版本", "required": False}
            ]
        )
        self.topic = topic
        self.testament = testament
        self.depth = depth
        self.version = version
    
    def render(
        self,
        topic: str = None,
        testament: str = None,
        depth: str = None,
        version: str = None
    ) -> str:
        """渲染主題串連指引
        
        Args:
            topic: 主題關鍵字（可選，使用時覆蓋初始化值）
            testament: 約別範圍（可選，使用時覆蓋初始化值）
            depth: 研究深度（可選，使用時覆蓋初始化值）
            version: 聖經版本（可選，使用時覆蓋初始化值）
        """
        # 使用傳入的參數或初始化時的值
        if topic is not None:
            self.topic = topic
        if testament is not None:
            self.testament = testament
        if depth is not None:
            self.depth = depth
        if version is not None:
            self.version = version
        
        testament_info = {
            "OT": "舊約聖經",
            "NT": "新約聖經",
            "both": "新舊約全書"
        }
        
        depth_info = {
            "overview": {"name": "概覽", "count": "5-10", "detail": "主要經文"},
            "detailed": {"name": "詳細", "count": "10-20", "detail": "重要經文及解說"},
            "exhaustive": {"name": "詳盡", "count": "20+", "detail": "全面經文及深入分析"}
        }
        
        testament_name = testament_info.get(self.testament, "新舊約全書")
        depth_data = depth_info.get(self.depth, depth_info["detailed"])
        
        prompt = f"""
═══════════════════════════════════════════════════
  🔗 聖經主題串連 - FHL Bible MCP Server
═══════════════════════════════════════════════════

歡迎使用主題串連系統！

🎯 主題：**{self.topic}**（{self.topic.upper()}）
📖 範圍：{testament_name}
📊 深度：{depth_data['name']}（{depth_data['count']} 處經文，{depth_data['detail']}）
📚 版本：{self.version.upper()}

本工具將幫助您：
• 追蹤主題在聖經中的發展
• 了解神學脈絡和演進
• 建立完整的主題認識
• 看見舊約預言與新約應驗的關聯

═══════════════════════════════════════════════════
  第一步：主題定義
═══════════════════════════════════════════════════

📚 **聖經中的「{self.topic}」**

請使用 search_bible 開始主題搜尋：
```
search_bible(
    query="{self.topic}",
    testament="{"both" if self.testament == "both" else "OT" if self.testament == "OT" else "NT"}",
    version="{self.version}"
)
```

1️⃣ **主題的聖經定義**

請協助定義這個主題：
• 聖經如何定義「{self.topic}」？
• 核心概念是什麼？
• 與其他概念的區別？

2️⃣ **相關原文字詞**

請使用 lookup_strongs 研究原文：

"""

        if self.testament in ["OT", "both"]:
            prompt += f"""**希伯來文（舊約）**：
• 主要字詞：______（編號：H____）
  - 字面意思：____________
  - 在聖經中的用法：____________
  - strongs://ot/____

• 相關字詞：______（編號：H____）
  - 含義：____________
  - strongs://ot/____

"""

        if self.testament in ["NT", "both"]:
            prompt += f"""**希臘文（新約）**：
• 主要字詞：______（編號：G____）
  - 字面意思：____________
  - 在聖經中的用法：____________
  - strongs://nt/____

• 相關字詞：______（編號：G____）
  - 含義：____________
  - strongs://nt/____

"""

        prompt += f"""3️⃣ **同義詞和相關概念**

與「{self.topic}」相關的其他概念：
• 同義詞：____________
• 反義詞：____________
• 相關主題：____________

建議也搜尋這些關鍵字，以獲得更完整的理解。

═══════════════════════════════════════════════════
  第二步：舊約追蹤
═══════════════════════════════════════════════════

"""

        if self.testament in ["OT", "both"]:
            prompt += f"""📜 **追蹤「{self.topic}」在舊約中的發展**

請按照聖經正典順序，找出關鍵經文：

1️⃣ **首次出現（First Mention Principle）**

「{self.topic}」在聖經中首次出現：
• 經文：________________
• 內容：________________
• 意義：首次提及往往奠定了主題的基礎含義

2️⃣ **摩西五經（Torah）**

律法書中的教導：
• 創世記：____________（經文：____）
  - 說明：____________
  
• 出埃及記：____________（經文：____）
  - 說明：____________
  
• 利未記：____________（經文：____）
  - 說明：____________
  
• 民數記：____________（經文：____）
  - 說明：____________
  
• 申命記：____________（經文：____）
  - 說明：____________

3️⃣ **歷史書（Historical Books）**

在以色列歷史中的實踐和例證：
• 約書亞記至以斯帖記
• 重要人物或事件：____________
• 關鍵經文：________________
• 歷史教訓：____________

4️⃣ **詩歌智慧書（Wisdom Literature）**

在讚美、禱告和智慧中的反思：
• 約伯記：____________（經文：____）
• 詩篇：____________（經文：____）
• 箴言：____________（經文：____）
• 傳道書：____________（經文：____）
• 雅歌：____________（經文：____）

詩歌書的獨特貢獻：
• 情感層面的表達
• 經驗性的智慧
• 敬拜中的應用

5️⃣ **先知書（Prophets）**

先知的宣告和預言：
• 以賽亞書：____________（經文：____）
• 耶利米書：____________（經文：____）
• 以西結書：____________（經文：____）
• 但以理書：____________（經文：____）
• 小先知書：____________（經文：____）

先知書的貢獻：
• 神的心意宣告
• 審判與安慰
• 彌賽亞預言
• 末世展望

📊 **舊約小結**

「{self.topic}」在舊約中的發展：
• 起源：____________
• 演進：____________
• 高峰：____________
• 指向：____________（如何指向基督）

"""
        else:
            prompt += "（僅研究新約，跳過舊約追蹤）\n\n"

        prompt += f"""═══════════════════════════════════════════════════
  第三步：新約發展
═══════════════════════════════════════════════════

"""

        if self.testament in ["NT", "both"]:
            prompt += f"""📖 **「{self.topic}」在新約中的成全**

新約如何完成和深化這個主題：

1️⃣ **四福音書（Gospels）**

耶穌基督的教導和示範：

• **馬太福音**：____________（經文：____）
  - 耶穌如何教導「{self.topic}」？
  - 關鍵教導：____________
  
• **馬可福音**：____________（經文：____）
  - 耶穌如何活出「{self.topic}」？
  - 行動示範：____________
  
• **路加福音**：____________（經文：____）
  - 強調重點：____________
  - 特殊觀點：____________
  
• **約翰福音**：____________（經文：____）
  - 神學深度：____________
  - 約翰的見證：____________

💡 **耶穌的典範**：
• 耶穌如何成為「{self.topic}」的完美典範？
• 十字架與復活如何體現這個主題？

2️⃣ **使徒行傳（Acts）**

初代教會的實踐：
• 關鍵經文：____________（經文：____）
• 教會如何活出「{self.topic}」？
• 聖靈的工作：____________
• 實踐見證：____________

3️⃣ **保羅書信（Pauline Epistles）**

神學性的闡述和應用：

• **羅馬書**：____________（經文：____）
  - 神學基礎：____________
  
• **哥林多前後書**：____________（經文：____）
  - 實際問題的應用：____________
  
• **加拉太書**：____________（經文：____）
  - 與律法的關係：____________
  
• **以弗所書**：____________（經文：____）
  - 在基督裡的意義：____________
  
• **腓立比書**：____________（經文：____）
  - 喜樂與經歷：____________
  
• **歌羅西書**：____________（經文：____）
  - 基督的超越：____________
  
• **帖撒羅尼迦前後書**：____________（經文：____）
  - 末世盼望：____________
  
• **教牧書信**（提前、提後、提多）：____________
  - 教會生活的應用：____________
  
• **腓利門書**：____________（經文：____）
  - 個人關係的體現：____________

4️⃣ **普通書信（General Epistles）**

其他使徒的見證：

• **希伯來書**：____________（經文：____）
  - 舊約與新約的連結：____________
  - 更美的約：____________
  
• **雅各書**：____________（經文：____）
  - 信心的行為：____________
  
• **彼得前後書**：____________（經文：____）
  - 受苦與盼望：____________
  
• **約翰一二三書**：____________（經文：____）
  - 愛與真理的平衡：____________
  
• **猶大書**：____________（經文：____）
  - 持守真道：____________

5️⃣ **啟示錄（Revelation）**

末世的完全：
• 關鍵經文：____________（經文：____）
• 「{self.topic}」在永恆中的完全實現
• 新天新地的展望：____________

📊 **新約小結**

「{self.topic}」在新約中的成全：
• 在基督裡的啟示：____________
• 透過聖靈的經歷：____________
• 在教會中的實踐：____________
• 末世的完全：____________

"""
        else:
            prompt += "（僅研究舊約，跳過新約發展）\n\n"

        prompt += f"""═══════════════════════════════════════════════════
  第四步：神學發展線
═══════════════════════════════════════════════════

📈 **追蹤「{self.topic}」的救恩歷史發展**

"""

        if self.testament == "both":
            prompt += f"""**從創世到永恆的完整軌跡**：

1. **創造（Creation）**
   • 在創造中的原初設計
   • 神的心意：____________

2. **墮落（Fall）**
   • 罪如何影響這個主題
   • 失去與扭曲：____________

3. **應許（Promise）**
   • 神的應許和約
   • 盼望的種子：____________

4. **預表（Type）**
   • 舊約的預表和影兒
   • 指向彌賽亞：____________

5. **道成肉身（Incarnation）**
   • 基督的來臨和示範
   • 完美的體現：____________

6. **救贖（Redemption）**
   • 十字架的成就
   • 復活的大能：____________

7. **五旬節（Pentecost）**
   • 聖靈的降臨和工作
   • 教會的經歷：____________

8. **成聖（Sanctification）**
   • 信徒生命中的成長
   • 漸進的更新：____________

9. **再來（Second Coming）**
   • 基督再來的盼望
   • 審判與獎賞：____________

10. **新天新地（New Heaven and Earth）**
    • 永恆中的完全
    • 最終的實現：____________

💡 **神學主線**：
從舊約到新約，我們看見「{self.topic}」如何：
• 從預言到應驗
• 從影兒到實體
• 從律法到恩典
• 從應許到成全
• 一切在基督裡達到高峰

"""
        elif self.testament == "OT":
            prompt += """**舊約中的發展**：
• 早期啟示：____________
• 律法時期：____________
• 王國時期：____________
• 先知時期：____________
• 被擄與歸回：____________
• 指向彌賽亞：____________
"""
        else:  # NT
            prompt += """**新約中的啟示**：
• 福音書中：____________
• 使徒行傳中：____________
• 書信教導中：____________
• 啟示錄中：____________
• 在基督裡的完全：____________
"""

        prompt += f"""

═══════════════════════════════════════════════════
  第五步：關鍵經文精選
═══════════════════════════════════════════════════

⭐ **「{self.topic}」主題 - 必讀經文清單**

請按{depth_data['name']}程度（{depth_data['count']} 處），
整理最重要的經文：

"""

        # 根據深度決定數量
        if self.depth == "overview":
            count_guide = "5-10"
            detail_level = "簡要說明"
        elif self.depth == "exhaustive":
            count_guide = "20-30"
            detail_level = "詳細解釋和應用"
        else:  # detailed
            count_guide = "10-20"
            detail_level = "適度解釋"

        prompt += f"""請列出 {count_guide} 處最重要的經文（{detail_level}）：

"""

        if self.testament in ["OT", "both"]:
            prompt += """**【舊約經文】**

1. ________________（經文出處）
   "________________"（經文內容）
   
   💡 重要性：____________
   📖 背景：____________
   🎯 核心信息：____________
   💭 與主題關聯：____________

2. ________________
   "________________"
   
   💡 重要性：____________
   📖 背景：____________
   🎯 核心信息：____________
   💭 與主題關聯：____________

（依此類推...）

"""

        if self.testament in ["NT", "both"]:
            prompt += """**【新約經文】**

1. ________________（經文出處）
   "________________"（經文內容）
   
   💡 重要性：____________
   📖 背景：____________
   🎯 核心信息：____________
   💭 與主題關聯：____________
   🔗 與舊約連結：____________

2. ________________
   "________________"
   
   💡 重要性：____________
   📖 背景：____________
   🎯 核心信息：____________
   💭 與主題關聯：____________
   🔗 與舊約連結：____________

（依此類推...）

"""

        prompt += f"""💡 **經文排序方式**：

可選擇以下排序：
• 按聖經正典順序（推薦）
• 按重要性（5星至1星）
• 按主題發展階段
• 按應用場景分類

═══════════════════════════════════════════════════
  第六步：實踐應用
═══════════════════════════════════════════════════

📝 **將「{self.topic}」活出來**

了解聖經真理後，如何實踐？

1️⃣ **個人層面**

如何在個人生命中活出「{self.topic}」：
• 思想：____________
• 態度：____________
• 行為：____________
• 習慣：____________

具體行動（SMART 原則）：
• 本週行動：____________
• 本月目標：____________
• 長期成長：____________

2️⃣ **關係層面**

在人際關係中的應用：
• 家庭：____________
• 教會：____________
• 職場：____________
• 社會：____________

3️⃣ **屬靈操練**

如何在靈修中深化這個主題：
• 禱告：根據經文禱告
• 默想：選擇關鍵經文默想
• 背誦：背誦代表性經文
• 分享：與他人分享心得

4️⃣ **教導他人**

如何將這個主題教導他人：
• 小組查經大綱
• 主日學課程
• 門徒訓練材料
• 傳福音應用

═══════════════════════════════════════════════════
  📊 主題研究總結
═══════════════════════════════════════════════════

**「{self.topic}」主題研究摘要**

📖 **研究範圍**：{testament_name}
🔍 **深度級別**：{depth_data['name']}
📚 **經文數量**：{count_guide} 處

**核心定義**：
_________________________________________________

**神學發展**：
_________________________________________________

**實踐要點**：
_________________________________________________

**推薦背誦**：
_________________________________________________

**延伸主題**：
_________________________________________________

═══════════════════════════════════════════════════

【工具快速參考】

搜尋主題經文：
• search_bible - 搜尋關鍵字
  query="{self.topic}"
  testament="{"both" if self.testament == "both" else self.testament}"

原文研究：
• lookup_strongs - 查詢原文字義
• get_word_analysis - 字詞分析

查詢註釋：
• get_commentary - 了解經文背景

書卷資訊：
• info://books - 書卷簡介

═══════════════════════════════════════════════════

📚 建議進一步研究的主題：

與「{self.topic}」相關的主題：
• ____________
• ____________
• ____________

可使用相同方法研究這些主題，建立完整的神學體系。

═══════════════════════════════════════════════════
"""
        
        return prompt.strip()
