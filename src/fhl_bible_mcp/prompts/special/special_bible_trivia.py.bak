"""聖經問答 Prompt

生成聖經知識問答題，可用於學習或小組活動。
"""

from typing import Optional
from ..base import PromptTemplate


class SpecialBibleTriviaPrompt(PromptTemplate):
    """聖經問答對話範本
    
    生成各種聖經知識問答題，包含：
    - 選擇題、填空題、配對題、簡答題、搶答題
    - 適用於個人學習、小組活動、主日學等
    """
    
    def __init__(
        self,
        category: str = "general",
        difficulty: str = "medium",
        count: int = 10,
        testament: str = "both"
    ):
        """初始化聖經問答 Prompt
        
        Args:
            category: 問答類別
                - general: 綜合（各類混合）
                - people: 聖經人物
                - places: 地名地點
                - events: 重要事件
                - teachings: 教導真理
                - books: 書卷認識
            difficulty: 難度級別
                - easy: 簡單（基礎知識）
                - medium: 中等（需思考）
                - hard: 困難（深入知識）
            count: 題目數量（預設：10）
            testament: 約別
                - OT: 僅舊約
                - NT: 僅新約
                - both: 新舊約都包含
        """
        super().__init__(
            name="special_bible_trivia",
            description="生成聖經知識問答題，可用於學習或小組活動",
            arguments=[
                {"name": "category", "description": "問答類別 (general/people/places/events/teachings/books)", "required": False},
                {"name": "difficulty", "description": "難度級別 (easy/medium/hard)", "required": False},
                {"name": "count", "description": "題目數量", "required": False},
                {"name": "testament", "description": "約別 (OT/NT/both)", "required": False}
            ]
        )
        self.category = category
        self.difficulty = difficulty
        self.count = count
        self.testament = testament
    
    def render(
        self,
        category: str = None,
        difficulty: str = None,
        count: int = None,
        testament: str = None
    ) -> str:
        """渲染聖經問答題
        
        Args:
            category: 問答類別（可選，使用時覆蓋初始化值）
            difficulty: 難度級別（可選，使用時覆蓋初始化值）
            count: 題目數量（可選，使用時覆蓋初始化值）
            testament: 約別（可選，使用時覆蓋初始化值）
        """
        # 使用傳入的參數或初始化時的值
        if category is not None:
            self.category = category
        if difficulty is not None:
            self.difficulty = difficulty
        if count is not None:
            self.count = count
        if testament is not None:
            self.testament = testament
        
        category_info = {
            "general": {"name": "綜合知識", "icon": "📚", "desc": "聖經各類知識混合"},
            "people": {"name": "聖經人物", "icon": "👤", "desc": "人物生平、事蹟、教訓"},
            "places": {"name": "地名地點", "icon": "🗺️", "desc": "聖經地理、城市、地點"},
            "events": {"name": "重要事件", "icon": "⚡", "desc": "重大事件、神蹟、歷史"},
            "teachings": {"name": "教導真理", "icon": "💡", "desc": "神學教義、倫理教導"},
            "books": {"name": "書卷認識", "icon": "📖", "desc": "書卷作者、主題、結構"}
        }
        
        difficulty_info = {
            "easy": {"name": "簡單級", "stars": "⭐", "desc": "基礎知識，容易回答"},
            "medium": {"name": "中等級", "stars": "⭐⭐⭐", "desc": "需要思考和理解"},
            "hard": {"name": "挑戰級", "stars": "⭐⭐⭐⭐⭐", "desc": "深入知識，較難回答"}
        }
        
        testament_info = {
            "OT": "舊約聖經",
            "NT": "新約聖經",
            "both": "新舊約全書"
        }
        
        cat = category_info.get(self.category, category_info["general"])
        diff = difficulty_info.get(self.difficulty, difficulty_info["medium"])
        test = testament_info.get(self.testament, "新舊約全書")
        
        prompt = f"""
═══════════════════════════════════════════════════
  🎯 聖經知識問答 - FHL Bible MCP Server
═══════════════════════════════════════════════════

歡迎參加聖經知識問答！

{cat['icon']} 類別：**{cat['name']}**
   說明：{cat['desc']}

{diff['stars']} 難度：**{diff['name']}**
   描述：{diff['desc']}

📊 題數：**{self.count} 題**
📖 範圍：**{test}**

本問答包含 5 種題型：
• 選擇題（Multiple Choice）
• 填空題（Fill in the Blank）
• 配對題（Matching）
• 簡答題（Short Answer）
• 搶答題（Quick Response）

═══════════════════════════════════════════════════
  📋 使用說明
═══════════════════════════════════════════════════

**個人使用**：
• 測試自己的聖經知識
• 複習學習過的內容
• 發現知識盲點

**小組使用**：
• 小組查經破冰活動
• 主日學課堂測驗
• 團契競賽遊戲
• 培靈會互動環節

**計分規則建議**：
• 選擇題：每題 10 分
• 填空題：每空 5 分
• 配對題：每對 5 分
• 簡答題：每題 15 分
• 搶答題：每題 10 分（答對加分，答錯扣分）

總分：{self.count * 10} 分

**評分標準**：
• 90-100 分：聖經專家 🏆
• 80-89 分：聖經達人 🌟
• 70-79 分：聖經通 📚
• 60-69 分：聖經學習者 📖
• 60 分以下：需要加強 💪

═══════════════════════════════════════════════════
  一、選擇題（Multiple Choice）
═══════════════════════════════════════════════════

請從四個選項中選出正確答案。

"""

        # 根據類別和難度提供題目範例指引
        prompt += self._generate_multiple_choice_guide()
        
        prompt += f"""

【題目格式】

第 X 題：（問題）____________？

A. ____________
B. ____________
C. ____________
D. ____________

正確答案：___
經文出處：____________
解析：____________

---

請協助生成 {max(2, self.count // 5)} 題選擇題。

使用以下工具輔助出題：
• search_bible - 搜尋相關經文
• get_bible_verse - 確認經文內容
• info://books - 查詢書卷資訊

═══════════════════════════════════════════════════
  二、填空題（Fill in the Blank）
═══════════════════════════════════════════════════

請填入正確的字詞或經文完成句子。

"""

        prompt += self._generate_fill_blank_guide()
        
        prompt += f"""

【題目格式】

第 X 題：

"____________，____________，____________。"
                        （經文出處）

答案：
1. ____________
2. ____________
3. ____________

---

請協助生成 {max(2, self.count // 5)} 題填空題。

💡 出題技巧：
• 選擇經典金句或重要經文
• 空格應選關鍵字詞
• 不要過於簡單或過於困難
• 提供完整的經文出處

═══════════════════════════════════════════════════
  三、配對題（Matching）
═══════════════════════════════════════════════════

將左右兩欄正確配對連線。

"""

        prompt += self._generate_matching_guide()
        
        prompt += f"""

【題目格式】

第 X 題：請將以下項目正確配對

【A 欄】          【B 欄】
1. ______      a. ______
2. ______      b. ______
3. ______      c. ______
4. ______      d. ______
5. ______      e. ______

正確答案：
1-___, 2-___, 3-___, 4-___, 5-___

經文依據：____________

---

請協助生成 {max(1, self.count // 10)} 組配對題（每組 5 對）。

💡 配對題型建議：
• 人物 vs 事蹟
• 書卷 vs 作者
• 地點 vs 事件
• 教導 vs 經文出處
• 預言 vs 應驗

═══════════════════════════════════════════════════
  四、簡答題（Short Answer）
═══════════════════════════════════════════════════

請用 2-3 句話回答問題。

"""

        prompt += self._generate_short_answer_guide()
        
        prompt += f"""

【題目格式】

第 X 題：____________？（15 分）

參考答案：
____________________________________________
____________________________________________
____________________________________________

經文依據：____________

評分要點：
□ ____________（5 分）
□ ____________（5 分）
□ ____________（5 分）

---

請協助生成 {max(2, self.count // 5)} 題簡答題。

💡 簡答題建議：
• 問題應開放但有明確答案
• 涵蓋理解和應用層面
• 提供清楚的評分標準
• 參考答案完整但不過長

═══════════════════════════════════════════════════
  五、搶答題（Quick Response）
═══════════════════════════════════════════════════

快速反應題，適合小組競賽使用。

"""

        prompt += self._generate_quick_response_guide()
        
        prompt += f"""

【題目格式】

第 X 題：____________？

答案：____________
經文：____________

---

請協助生成 {max(2, self.count // 5)} 題搶答題。

💡 搶答題特點：
• 問題簡短明確
• 答案唯一清楚
• 適合口頭快速回答
• 可設時間限制（5-10 秒）

🎮 **搶答規則建議**：
• 答對：+10 分
• 答錯：-5 分
• 不答：0 分
• 搶答權：先舉手者

═══════════════════════════════════════════════════
  📊 完整題目清單
═══════════════════════════════════════════════════

請按以下配置生成 **{self.count} 題**：

• 選擇題：{max(2, self.count // 5)} 題（每題 10 分）
• 填空題：{max(2, self.count // 5)} 題（每空 5 分）
• 配對題：{max(1, self.count // 10)} 組（每對 5 分）
• 簡答題：{max(2, self.count // 5)} 題（每題 15 分）
• 搶答題：{max(2, self.count // 5)} 題（每題 10 分）

📝 **出題原則**：

1. **準確性**：
   • 所有答案必須有聖經依據
   • 使用 search_bible 和 get_bible_verse 確認
   • 提供完整的經文出處

2. **平衡性**：
   • 涵蓋不同書卷和主題
   • 難易度適中
   • {"舊約和新約都包含" if self.testament == "both" else "僅" + test}

3. **教育性**：
   • 每題都有學習價值
   • 解析清楚易懂
   • 鼓勵進一步查經

4. **趣味性**：
   • 題目設計有吸引力
   • 避免過於枯燥
   • 適合小組互動

═══════════════════════════════════════════════════
  🎯 答題技巧提示
═══════════════════════════════════════════════════

給參加者的建議：

✅ **答題前**：
• 仔細閱讀題目
• 注意關鍵字詞
• 回想相關經文
• 不確定時排除明顯錯誤選項

✅ **答題中**：
• 相信第一直覺
• 不要過度思考
• 注意題目陷阱
• 善用刪去法

✅ **答題後**：
• 檢查答案
• 閱讀解析學習
• 查閱相關經文
• 記錄錯誤題目

═══════════════════════════════════════════════════
  📚 延伸學習建議
═══════════════════════════════════════════════════

完成問答後的學習建議：

1️⃣ **複習錯誤**
• 將答錯的題目記錄下來
• 查閱相關經文
• 使用 get_commentary 深入理解
• 背誦相關經文

2️⃣ **主題研究**
• 發現感興趣的主題
• 使用 search_bible 找更多相關經文
• 考慮使用 special_topical_chain 進行主題研究

3️⃣ **小組分享**
• 與小組討論有趣的題目
• 分享各自的答題心得
• 一起查考難題

4️⃣ **持續學習**
• 定期進行聖經問答
• 逐漸提高難度
• 擴展知識範圍

═══════════════════════════════════════════════════

【工具快速參考】

搜尋經文：
• search_bible - 搜尋關鍵字確認答案

查詢經文：
• get_bible_verse - 取得準確經文
• get_bible_chapter - 查詢整章內容

書卷資訊：
• info://books - 書卷簡介和統計

查詢註釋：
• get_commentary - 深入理解

═══════════════════════════════════════════════════

🎓 主持人須知（小組使用）

**活動流程**：
1. 說明規則和計分方式（5 分鐘）
2. 進行問答（30-45 分鐘）
3. 公布答案和解析（10-15 分鐘）
4. 頒獎和鼓勵（5 分鐘）

**主持技巧**：
• 保持活潑有趣
• 掌握節奏時間
• 鼓勵參與
• 強調學習而非競爭
• 準備小禮物獎勵

**注意事項**：
• 確保所有答案正確
• 準備額外題目以防用完
• 留意難度是否適合參加者
• 營造友善的競賽氣氛

═══════════════════════════════════════════════════

💡 "你們要休息，要知道我是神！"（詩篇 46:10）

在享受問答樂趣的同時，
更重要的是認識神、愛神、敬拜神！

═══════════════════════════════════════════════════
"""
        
        return prompt.strip()
    
    def _generate_multiple_choice_guide(self) -> str:
        """生成選擇題指引"""
        if self.category == "people":
            return """💡 **人物類選擇題範例**：

"誰是舊約中被稱為『神人』的先知？"
A. 以利亞
B. 以利沙  
C. 摩西
D. 撒母耳

（根據實際情況生成題目）
"""
        elif self.category == "places":
            return """💡 **地點類選擇題範例**：

"耶穌在哪裡行了第一個神蹟？"
A. 迦拿
B. 耶路撒冷
C. 拿撒勒
D. 迦百農

（根據實際情況生成題目）
"""
        elif self.category == "events":
            return """💡 **事件類選擇題範例**：

"以色列人過紅海是在哪位領袖帶領下？"
A. 亞伯拉罕
B. 摩西
C. 約書亞
D. 大衛

（根據實際情況生成題目）
"""
        else:
            return """💡 **綜合類選擇題範例**：

"『愛是恆久忍耐』出自哪卷書？"
A. 羅馬書
B. 哥林多前書
C. 以弗所書
D. 腓立比書

（根據實際情況生成題目）
"""
    
    def _generate_fill_blank_guide(self) -> str:
        """生成填空題指引"""
        return """💡 **填空題範例**：

"_____ 是我的 _____，我必不至 _____。"
                        （詩篇 23:1）

答案：耶和華、牧者、缺乏

（請選擇經典金句或重要教導）
"""
    
    def _generate_matching_guide(self) -> str:
        """生成配對題指引"""
        if self.category == "people":
            return """💡 **人物配對範例**：

【人物】          【事蹟】
1. 挪亞          a. 建造聖殿
2. 亞伯拉罕      b. 造方舟
3. 摩西          c. 領受十誡
4. 大衛          d. 信心之父
5. 所羅門        e. 合神心意的人

（根據類別調整配對內容）
"""
        elif self.category == "books":
            return """💡 **書卷配對範例**：

【書卷】          【作者】
1. 詩篇          a. 保羅
2. 箴言          b. 路加
3. 羅馬書        c. 大衛
4. 路加福音      d. 所羅門
5. 啟示錄        e. 約翰

（根據類別調整配對內容）
"""
        else:
            return """💡 **配對題範例**：

根據類別設計適當的配對內容。
"""
    
    def _generate_short_answer_guide(self) -> str:
        """生成簡答題指引"""
        return """💡 **簡答題範例**：

"為什麼神要揀選以色列民族？請簡要說明。"

參考答案：
神揀選以色列不是因為他們人數眾多或特別優秀，
而是因為神愛他們，要信守對他們列祖所起的誓。
神藉以色列彰顯祂的榮耀，並預備救恩臨到萬國。

（請設計需要理解和思考的問題）
"""
    
    def _generate_quick_response_guide(self) -> str:
        """生成搶答題指引"""
        return """💡 **搶答題範例**：

"聖經一共有幾卷書？"
答案：66 卷

"耶穌的十二門徒中誰出賣了祂？"
答案：猶大

（設計答案明確、可快速回答的題目）
"""
