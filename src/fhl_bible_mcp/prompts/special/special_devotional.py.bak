"""靈修材料 Prompt

生成個人或小組靈修材料，包含默想、禱告和應用。
"""

from typing import Optional
from ..base import PromptTemplate


class SpecialDevotionalPrompt(PromptTemplate):
    """靈修材料對話範本
    
    根據經文生成靈修材料，適用於：
    - 個人靈修（personal）
    - 小組查經（group）
    - 家庭靈修（family）
    
    包含完整的靈修流程：
    - 開場禱告
    - 經文閱讀
    - 背景簡介
    - 重點觀察
    - 默想問題
    - 實際應用
    - 禱告方向
    - 金句卡片
    """
    
    def __init__(
        self,
        passage: str = "Psalm 23",
        format: str = "personal",
        duration: str = "medium",
        version: str = "unv"
    ):
        """初始化靈修材料 Prompt
        
        Args:
            passage: 經文（章節或段落，如 "Psalm 23" 或 "John 3:16-21"，預設：Psalm 23）
            format: 靈修格式
                - personal: 個人靈修
                - group: 小組查經
                - family: 家庭靈修
            duration: 時長
                - short: 短（15-20分鐘）
                - medium: 中（30-40分鐘）
                - long: 長（60分鐘以上）
            version: 聖經版本（預設：unv 和合本）
        """
        super().__init__(
            name="special_devotional",
            description="根據經文生成靈修材料，包含默想、禱告和應用",
            arguments=[
                {"name": "passage", "description": "經文（章節或段落）", "required": False},
                {"name": "format", "description": "靈修格式 (personal/group/family)", "required": False},
                {"name": "duration", "description": "時長 (short/medium/long)", "required": False},
                {"name": "version", "description": "聖經版本", "required": False}
            ]
        )
        self.passage = passage
        self.format = format
        self.duration = duration
        self.version = version
    
    def render(
        self,
        passage: str = None,
        format: str = None,
        duration: str = None,
        version: str = None
    ) -> str:
        """渲染靈修材料
        
        Args:
            passage: 經文（可選，使用時覆蓋初始化值）
            format: 靈修格式（可選，使用時覆蓋初始化值）
            duration: 時長（可選，使用時覆蓋初始化值）
            version: 聖經版本（可選，使用時覆蓋初始化值）
        """
        # 使用傳入的參數或初始化時的值
        if passage is not None:
            self.passage = passage
        if format is not None:
            self.format = format
        if duration is not None:
            self.duration = duration
        if version is not None:
            self.version = version
        
        format_info = {
            "personal": {
                "name": "個人靈修",
                "icon": "🙏",
                "focus": "個人與神的親密相交",
                "style": "深度默想，個人反思"
            },
            "group": {
                "name": "小組查經",
                "icon": "👥",
                "focus": "肢體互動，彼此造就",
                "style": "討論分享，實踐應用"
            },
            "family": {
                "name": "家庭靈修",
                "icon": "👨‍👩‍👧‍👦",
                "focus": "全家屬靈成長",
                "style": "適齡互動，家庭建造"
            }
        }
        
        duration_info = {
            "short": {"time": "15-20 分鐘", "depth": "精簡", "questions": 2},
            "medium": {"time": "30-40 分鐘", "depth": "適中", "questions": 4},
            "long": {"time": "60+ 分鐘", "depth": "深入", "questions": 6}
        }
        
        fmt = format_info.get(self.format, format_info["personal"])
        dur = duration_info.get(self.duration, duration_info["medium"])
        
        prompt = f"""
═══════════════════════════════════════════════════
  {fmt['icon']} {fmt['name']}靈修材料
  FHL Bible MCP Server
═══════════════════════════════════════════════════

📖 經文：{self.passage}
⏰ 時長：{dur['time']}
📚 版本：{self.version.upper()}
🎯 焦點：{fmt['focus']}

═══════════════════════════════════════════════════
  第一步：開場禱告
═══════════════════════════════════════════════════

"""

        if self.format == "personal":
            prompt += """🙏 **個人開場禱告**

親愛的天父，
感謝祢透過聖經向我說話。
求祢打開我心靈的眼睛，
讓我能明白祢話語的真理。
願聖靈光照引導，
使我不只是聽道，也能行道。
奉主耶穌基督的名禱告，阿們。

💡 **準備心靈**
• 找一個安靜的地方
• 放下手機和雜念
• 預備紙筆記錄感動
• 敞開心迎接神的話語
"""
        elif self.format == "group":
            prompt += """👥 **小組開場禱告**

（建議由組長或輪流帶領禱告）

親愛的天父，
感謝祢讓我們今天能夠聚集，
一同來到祢的話語面前。
求祢的靈運行在我們當中，
賜下悟性，使我們明白真理。
願我們的分享和討論都蒙祢喜悅，
彼此造就，一同成長。
奉主耶穌基督的名禱告，阿們。

💡 **小組須知**
• 彼此尊重，認真聆聽
• 誠實分享，互相守密
• 不批評論斷
• 手機靜音，專心參與
• 預備紙筆記錄
"""
        else:  # family
            prompt += """👨‍👩‍👧‍👦 **家庭靈修禱告**

（可由家長帶領，或讓孩子輪流禱告）

親愛的天父，
謝謝祢愛我們這個家庭。
今天我們全家一起來讀聖經，
求祢幫助我們明白祢的話，
也幫助我們每個人都能學到重要的功課。
讓我們的家更有愛，更榮耀祢。
奉主耶穌的名禱告，阿們。

💡 **家庭靈修小貼士**
• 選擇全家方便的時間
• 營造溫馨舒適的氛圍
• 鼓勵每個成員參與
• 使用適齡的語言
• 可搭配小遊戲或活動
"""

        prompt += f"""

═══════════════════════════════════════════════════
  第二步：經文閱讀
═══════════════════════════════════════════════════

📖 **今日經文：{self.passage}**

請使用以下方式取得經文：

**方法 1：直接查詢**
```
get_bible_chapter 或 get_bible_verses
書卷：{self._parse_book()}
章節：{self._parse_chapter()}
版本：{self.version}
```

**方法 2：使用 URI**
```
bible://{self.version}/{self._parse_book()}/{self._parse_chapter()}
```

📚 **建議閱讀方式**

"""

        if self.duration == "short":
            prompt += """• 靜默閱讀一次
• 標記有感動的經節
"""
        elif self.duration == "long":
            prompt += """• 第一次：快速瀏覽，了解大意
• 第二次：仔細閱讀，標記重點
• 第三次：大聲朗讀，默想內化
• 可聆聽音訊版本（使用 get_audio_chapter_with_text）
"""
        else:  # medium
            prompt += """• 第一次：靜默閱讀，了解大意
• 第二次：大聲朗讀或聆聽音訊
• 標記有感動或疑問的經節
"""

        if self.format == "group":
            prompt += """
💡 **小組閱讀建議**
• 輪流朗讀（每人讀 2-3 節）
• 或由一人朗讀，其他人跟讀
• 鼓勵不同組員用不同語氣朗讀
"""
        elif self.format == "family":
            prompt += """
💡 **家庭閱讀建議**
• 父母先讀一次
• 讓孩子也參與朗讀（可讀部分經節）
• 可用問答方式確認孩子理解
• 年幼孩子可用兒童聖經版本搭配
"""

        prompt += f"""

═══════════════════════════════════════════════════
  第三步：背景簡介
═══════════════════════════════════════════════════

請使用以下工具了解經文背景：

📚 **書卷資訊**
```
使用 info://books 查詢 {self._parse_book()} 的背景
```

📖 **經文背景**（1-2 段簡介）

請提供以下資訊：
1. 這段經文的歷史文化背景
2. 作者寫作的目的和對象
3. 這段經文在全書中的位置
4. 與我們今天的關聯

💡 背景簡介應：
• 簡潔易懂（特別是 {fmt['name']}）
• 幫助理解經文含義
• 不宜過長，避免喧賓奪主

═══════════════════════════════════════════════════
  第四步：重點觀察
═══════════════════════════════════════════════════

請協助觀察經文中的重要元素：

🔍 **觀察問題**（可使用 get_word_analysis 和 lookup_strongs）

1. **關鍵字詞**
   • 哪些字詞重複出現？
   • 哪些字詞特別重要？
   • 原文有什麼特殊含義？

2. **人物或角色**
   • 經文中有哪些人物？
   • 他們做了什麼？
   • 他們的態度或反應如何？

3. **重要動作或事件**
   • 發生了什麼事？
   • 事件的因果關係？
   • 結果如何？

4. **對比或比較**
   • 有哪些對比（光與暗、生與死等）？
   • 有什麼比喻或象徵？

5. **應許或命令**
   • 神的應許是什麼？
   • 神的命令是什麼？
   • 對我們的要求？

📝 **重點摘要**（3-5 點）

請整理本段經文的主要信息：
• 第一要點：____________
• 第二要點：____________
• 第三要點：____________
（如有必要可增加至 5 點）

═══════════════════════════════════════════════════
  第五步：默想問題
═══════════════════════════════════════════════════

"""

        # 根據格式提供不同的問題類型
        if self.format == "personal":
            prompt += f"""💭 **個人默想問題**（{dur['questions']} 個）

請思考以下問題，誠實地在神面前省察：

1. **理解層面**
   • 這段經文的核心信息是什麼？
   • 我是否真正明白神要說的話？

2. **個人反思**
   • 這段經文對我說了什麼？
   • 神透過這段經文要光照我哪個部分？
   • 我生命中哪裡需要改變？

3. **實際應用**
   • 我可以如何回應神的話？
   • 今天我要採取什麼具體行動？
   • 我需要向誰道歉、饒恕或和好？

4. **信心操練**
   • 這段經文如何堅固我的信心？
   • 我要如何更信靠神？
"""
        elif self.format == "group":
            prompt += f"""💬 **小組討論問題**（{dur['questions']} 個）

請逐題討論，鼓勵每位組員分享：

1. **破冰問題**（輕鬆開場）
   • 這段經文哪一節最觸動你？為什麼？
   • 有沒有不明白的地方？

2. **理解問題**
   • 這段經文的背景和含義是什麼？
   • 對當時的讀者有什麼意義？

3. **應用問題**
   • 這段經文對我們今天有什麼意義？
   • 我們可以如何實踐？

4. **分享見證**
   • 有沒有人曾經經歷過類似的事？
   • 神如何在你生命中成就祂的話？

5. **行動問題**
   • 本週我們可以做什麼具體行動？
   • 我們如何彼此守望，互相幫助？

💡 **組長提示**
• 掌握時間，避免離題
• 鼓勵較安靜的組員發言
• 分享要真實，不要屬靈術語堆砌
• 守密原則：小組內的分享不外傳
"""
        else:  # family
            prompt += f"""👨‍👩‍👧‍👦 **家庭討論問題**（{dur['questions']} 個，適齡調整）

請全家一起討論，鼓勵每個人參與：

1. **給小朋友**（簡單具體）
   • 今天的聖經故事/經文在說什麼？
   • 你最喜歡哪一句話？為什麼？
   • 你覺得神要我們怎麼做？

2. **給青少年**（貼近生活）
   • 這段經文跟你的生活有什麼關係？
   • 在學校或朋友中，你可以怎麼應用？
   • 有沒有遇到什麼挑戰？

3. **給父母**（深入反思）
   • 我們如何在家中活出這段經文的教導？
   • 我們的家庭可以如何更榮耀神？
   • 我們要為家人禱告什麼？

4. **全家討論**
   • 我們家可以一起做什麼？
   • 本週的家庭目標是什麼？

💡 **家長提示**
• 用孩子聽得懂的語言
• 讚美孩子的參與和分享
• 不要說教，而是引導思考
• 以身作則，做榜樣
"""

        prompt += """

═══════════════════════════════════════════════════
  第六步：實際應用
═══════════════════════════════════════════════════

📝 **ACTS 應用法**

請思考如何將經文應用到生活中：

**A - Adoration（敬拜讚美）**
• 這段經文讓我認識神的哪些屬性？
• 我要如何讚美敬拜祂？

**C - Confession（認罪悔改）**
• 這段經文光照我哪些罪或軟弱？
• 我需要向神認罪悔改什麼？

**T - Thanksgiving（感恩）**
• 我要為什麼感謝神？
• 神過去如何恩待我？

**S - Supplication（祈求）**
• 我要向神祈求什麼？
• 我要為誰代禱？

💡 **行動計劃**（SMART 原則）

請制定一個具體可行的行動計劃：

• **Specific**（具體）：我要做什麼？
  例：________________

• **Measurable**（可衡量）：如何知道我做到了？
  例：________________

• **Achievable**（可達成）：這是否實際可行？
  例：________________

• **Relevant**（相關）：與經文信息相關
  例：________________

• **Time-bound**（有時限）：什麼時候完成？
  例：本週內／本月內

"""

        if self.format == "group":
            prompt += """
📋 **小組行動約定**

小組可以一起：
• 選定一個共同的行動目標
• 彼此督促，互相代禱
• 下次聚會分享實踐心得
• 見證神的作為
"""
        elif self.format == "family":
            prompt += """
👨‍👩‍👧‍👦 **家庭行動計劃**

全家可以一起：
• 決定一個家庭實踐目標
• 製作提醒卡或海報
• 每天互相鼓勵
• 週末一起回顧分享
"""

        prompt += f"""

═══════════════════════════════════════════════════
  第七步：禱告方向
═══════════════════════════════════════════════════

🙏 **根據經文禱告**

請根據這段經文的內容禱告：

**1. 為自己禱告**
• 求神幫助我明白並遵行祂的話
• 求聖靈賜力量活出真理
• 求神改變我的生命

**2. 為家人禱告**
• （為配偶、父母、兒女、手足禱告）
• 求神祝福保守家人
• 求神在家人心中動工

**3. 為教會禱告**
• 為牧者傳道同工
• 為肢體關係
• 為教會事工

**4. 為社會禱告**
• 為國家領袖
• 為社會公義
• 為福音廣傳

"""

        if self.format == "personal":
            prompt += """
💡 **個人禱告建議**
• 安靜在神面前
• 誠實傾心吐意
• 可寫下禱告日記
• 等候神的回應
"""
        elif self.format == "group":
            prompt += """
💡 **小組禱告建議**
• 分享代禱事項（彼此守密）
• 可分小組 2-3 人一起禱告
• 或圍圈站立，彼此按手禱告
• 最後由組長作總結禱告
"""
        else:  # family
            prompt += """
💡 **家庭禱告建議**
• 可圍圈牽手一起禱告
• 讓每個家人都參與禱告
• 小朋友可禱告簡單的話
• 父母為孩子祝福禱告
"""

        prompt += f"""

═══════════════════════════════════════════════════
  第八步：金句卡片
═══════════════════════════════════════════════════

📇 **本日金句**

從 {self.passage} 中選出一節金句背誦：

╔═══════════════════════════════════════════════╗
║                                               ║
║    （請從經文中選出一節核心經文）                ║
║                                               ║
║    「________________________________」        ║
║                                               ║
║                 - {self.passage}              ║
║                                               ║
╚═══════════════════════════════════════════════╝

💡 **記憶金句建議**

請使用 search_bible 找出相關經文：
• 與這個主題相關的其他經文
• 可串連記憶

背誦方法：
• 寫在卡片上，放在常看到的地方
• 設為手機桌布或提醒
• 每天複誦 3 次
• 與家人或小組彼此背誦

═══════════════════════════════════════════════════
  📝 靈修筆記
═══════════════════════════════════════════════════

請記錄今天的收穫：

**今日領受**：
_________________________________________________
_________________________________________________

**感動之處**：
_________________________________________________
_________________________________________________

**需要改變**：
_________________________________________________
_________________________________________________

**禱告事項**：
_________________________________________________
_________________________________________________

═══════════════════════════════════════════════════

【工具快速參考】

查詢經文：
• get_bible_chapter - 取得整章
• get_bible_verses - 取得經文範圍  
• URI: bible://{self.version}/{self._parse_book()}/...

聆聽音訊：
• list_audio_versions - 列出音訊版本
• get_audio_chapter_with_text - 取得音訊朗讀

原文研究：
• get_word_analysis - 字詞分析
• lookup_strongs - Strong's 字典

搜尋相關經文：
• search_bible - 搜尋關鍵字

查詢註釋：
• get_commentary - 取得註釋

書卷資訊：
• info://books - 書卷簡介

═══════════════════════════════════════════════════

🕊️ 願神的話語成為你腳前的燈，路上的光！

"惟喜愛耶和華的律法，晝夜思想，這人便為有福！"
                              （詩篇 1:2）

═══════════════════════════════════════════════════
"""
        
        return prompt.strip()
    
    def _parse_book(self) -> str:
        """解析書卷名稱"""
        parts = self.passage.split()
        if parts:
            # 處理如 "1 John" 或 "Psalm 23"
            if parts[0].isdigit() and len(parts) > 1:
                return parts[0] + parts[1]
            return parts[0]
        return "John"
    
    def _parse_chapter(self) -> str:
        """解析章數"""
        import re
        match = re.search(r'(\d+)', self.passage.split()[-1])
        if match:
            return match.group(1)
        return "1"
