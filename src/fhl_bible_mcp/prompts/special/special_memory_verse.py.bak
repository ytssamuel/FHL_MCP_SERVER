"""背經輔助 Prompt

協助選擇、理解和背誦經文。
"""

from typing import Optional
from ..base import PromptTemplate


class SpecialMemoryVersePrompt(PromptTemplate):
    """背經輔助對話範本
    
    協助用戶：
    - 根據主題或書卷推薦適合背誦的經文
    - 提供背誦計劃和記憶技巧
    - 理解經文意義
    - 建立複習系統
    """
    
    def __init__(
        self,
        topic: Optional[str] = None,
        book: Optional[str] = None,
        difficulty: str = "medium",
        version: str = "unv"
    ):
        """初始化背經輔助 Prompt
        
        Args:
            topic: 主題（如 "faith", "love", "peace"，可選）
            book: 特定書卷（如 "Psalm", "John"，可選）
            difficulty: 難度級別
                - easy: 簡單（短而易記）
                - medium: 中等（一般長度）
                - hard: 困難（較長或深奧）
            version: 聖經版本（預設：unv 和合本）
        """
        super().__init__(
            name="special_memory_verse",
            description="幫助選擇、理解和背誦經文",
            arguments=[
                {"name": "topic", "description": "主題關鍵字", "required": False},
                {"name": "book", "description": "特定書卷", "required": False},
                {"name": "difficulty", "description": "難度級別 (easy/medium/hard)", "required": False},
                {"name": "version", "description": "聖經版本", "required": False}
            ]
        )
        self.topic = topic
        self.book = book
        self.difficulty = difficulty
        self.version = version
    
    def render(
        self,
        topic: str = None,
        book: str = None,
        difficulty: str = None,
        version: str = None
    ) -> str:
        """渲染背經輔助指引
        
        Args:
            topic: 主題（可選，使用時覆蓋初始化值）
            book: 特定書卷（可選，使用時覆蓋初始化值）
            difficulty: 難度級別（可選，使用時覆蓋初始化值）
            version: 聖經版本（可選，使用時覆蓋初始化值）
        """
        # 使用傳入的參數或初始化時的值
        if topic is not None:
            self.topic = topic
        if book is not None:
            self.book = book
        if difficulty is not None:
            self.difficulty = difficulty
        if version is not None:
            self.version = version
        
        difficulty_info = {
            "easy": {
                "name": "簡單級",
                "length": "1 節，10-15 字以內",
                "suitable": "初學者、兒童、剛開始背經的信徒"
            },
            "medium": {
                "name": "中等級",
                "length": "1-2 節，15-30 字",
                "suitable": "有一定背經經驗的信徒"
            },
            "hard": {
                "name": "挑戰級",
                "length": "2節以上或較長經文",
                "suitable": "有豐富背經經驗、追求深度記憶的信徒"
            }
        }
        
        diff = difficulty_info.get(self.difficulty, difficulty_info["medium"])
        
        topic_hint = f"主題：**{self.topic}**" if self.topic else "主題：（未指定，將推薦經典金句）"
        book_hint = f"書卷：**{self.book}**" if self.book else "書卷：（未指定，將從全聖經中推薦）"
        
        prompt = f"""
═══════════════════════════════════════════════════
  📖 背經輔助系統 - FHL Bible MCP Server
═══════════════════════════════════════════════════

歡迎使用聖經背誦助手！

{topic_hint}
{book_hint}
📊 難度：{diff['name']}（{diff['length']}）
👥 適合對象：{diff['suitable']}
📚 版本：{self.version.upper()}

"我將你的話藏在心裡，免得我得罪你。"
                        （詩篇 119:11）

═══════════════════════════════════════════════════
  第一步：經文推薦
═══════════════════════════════════════════════════

請使用 search_bible 工具找出適合背誦的經文：

"""

        if self.topic:
            prompt += f"""
🎯 **主題搜尋：{self.topic}**

請搜尋與「{self.topic}」相關的經文：
```
search_bible(
    query="{self.topic}",
    testament="both",
    version="{self.version}"
)
```

篩選標準：
• 長度：{diff['length']}
• 內容清晰，意義明確
• 實用性強，容易應用
• 文字優美，容易記憶
"""
        elif self.book:
            prompt += f"""
📚 **書卷搜尋：{self.book}**

請從 {self.book} 中推薦金句：
```
get_bible_book("{self.book}", version="{self.version}")
```

推薦原則：
• 該書卷的經典金句
• 長度：{diff['length']}
• 代表性強
• 容易記憶和應用
"""
        else:
            prompt += f"""
⭐ **經典金句推薦**

請推薦聖經中最經典的背誦經文（{diff['name']}）：
"""

        # 根據難度提供建議經文
        if self.difficulty == "easy":
            prompt += """
建議經文類型：
• 短小精悍的應許
• 神的屬性宣告
• 簡單的命令或教導
• 安慰鼓勵的話

推薦範例：
• 約翰福音 3:16（神愛世人）
• 詩篇 23:1（耶和華是我的牧者）
• 箴言 3:5-6（你要專心仰賴耶和華）
• 腓立比書 4:13（靠著那加給我力量的）
• 約翰一書 4:8（神就是愛）
"""
        elif self.difficulty == "hard":
            prompt += """
建議經文類型：
• 較長的段落（2節以上）
• 神學性較強的經文
• 詩歌體或比喻
• 系統性的教導

推薦範例：
• 以賽亞書 53:4-6（代贖的預言）
• 羅馬書 8:38-39（神的愛）
• 腓立比書 2:5-11（基督的謙卑）
• 希伯來書 11:1-3（信的定義）
• 詩篇 1:1-3（有福的人）
"""
        else:  # medium
            prompt += """
建議經文類型：
• 1-2節完整的教導
• 平衡深度與長度
• 實用性強

推薦範例：
• 馬太福音 6:33（先求神的國）
• 羅馬書 12:1-2（獻上自己當作活祭）
• 以賽亞書 40:31（等候耶和華的必重新得力）
• 雅各書 1:2-3（試煉與信心）
• 箴言 16:3（將你的事交託耶和華）
"""

        prompt += f"""

📋 **推薦經文列表**（請協助找出 5-10 處）

請列出推薦背誦的經文，格式如下：

1. ________________（經文出處）
   "________________"（經文內容）
   主題標籤：#_____ #_____ 
   背誦優先級：⭐⭐⭐⭐⭐

2. ________________
   "________________"
   主題標籤：#_____ #_____
   背誦優先級：⭐⭐⭐⭐

（依此類推...）

💡 每處經文請提供：
• 完整的經文出處和內容
• 相關主題標籤
• 優先級評分（1-5星）

═══════════════════════════════════════════════════
  第二步：背誦計劃
═══════════════════════════════════════════════════

📅 **4 週背誦計劃**

建議採用系統化的背誦方法：

**第1週：熟悉階段**
□ 第1天：仔細閱讀經文 10 次，理解含義
□ 第2天：分段記憶，每次 1-2 個短句
□ 第3天：連貫背誦，看著經文複誦
□ 第4天：嘗試不看經文背誦，卡住時查看
□ 第5天：完整背誦，錄音檢查
□ 第6-7天：複習鞏固

**第2週：鞏固階段**
□ 每天：早中晚各背誦一次
□ 使用：不同場景（走路、等車、睡前）
□ 目標：流暢背出，不卡頓

**第3週：應用階段**
□ 默想經文含義
□ 思考實際應用
□ 在禱告中引用
□ 分享給他人

**第4週：長期記憶**
□ 每天複習一次
□ 與相關經文串連
□ 寫下應用見證
□ 教導他人背誦

💡 **背誦技巧**

1. **分段記憶法**
   將經文分成 3-5 個小段：
   • 段1：____________
   • 段2：____________
   • 段3：____________
   • 然後串連起來

2. **關鍵字法**
   提取每句的關鍵字：
   • 關鍵字1：________
   • 關鍵字2：________
   • 關鍵字3：________
   • 用關鍵字串連全文

3. **視覺化記憶**
   • 想像經文描述的畫面
   • 製作圖像或心智圖
   • 用顏色標註重點

4. **韻律節奏**
   • 找出經文的節奏感
   • 配合簡單旋律
   • 或用固定節拍複誦

5. **抄寫法**
   • 手抄經文 3-5 遍
   • 邊寫邊記
   • 利用肌肉記憶

═══════════════════════════════════════════════════
  第三步：理解輔助
═══════════════════════════════════════════════════

不只是背誦，更要明白意義！

📖 **經文解析**

請使用以下工具深入理解經文：

1️⃣ **原文字義**
```
使用 get_word_analysis 或 lookup_strongs
分析關鍵字詞的原文含義
```

重點字詞：
• 字詞1：______（原文：____，意思：____）
• 字詞2：______（原文：____，意思：____）
• 字詞3：______（原文：____，意思：____）

2️⃣ **背景說明**
```
使用 get_commentary 查詢註釋
使用 info://books 了解書卷背景
```

• 歷史背景：____________
• 文化背景：____________
• 作者意圖：____________
• 原始聽眾：____________

3️⃣ **神學意義**
• 這段經文啟示了神的哪些屬性？
• 與福音有什麼關係？
• 對救恩有什麼教導？
• 如何指向基督？

4️⃣ **實際意義**
• 對我們今天的意義？
• 如何應用在生活中？
• 哪些情境可以用上？
• 如何成為我的幫助？

💡 **默想問題**

請思考：
1. 這節經文最觸動我的是什麼？
2. 神透過這節經文對我說什麼？
3. 我要如何回應神的話？
4. 我生命中哪裡需要這節經文？

═══════════════════════════════════════════════════
  第四步：記憶技巧
═══════════════════════════════════════════════════

🧠 **進階記憶法**

1. **首字母法**（Acrostic）
   取每個字的第一個字：
   例：「你要專心仰賴耶和華」
   → 「你專仰」

2. **串珠記憶法**
   將相關經文串連記憶：
   • 使用 search_bible 找相關經文
   • 同主題的經文一起背
   • 例：「信心」主題串
     - 希伯來書 11:1
     - 羅馬書 10:17
     - 雅各書 2:17

3. **場景聯想法**
   • 在特定地點背特定經文
   • 看到特定事物就想起經文
   • 例：看到山 → 詩篇 121:1

4. **圖像記憶法**
   • 畫出經文的圖像
   • 製作經文卡片
   • 使用符號或表情符號

5. **教導記憶法**
   • 背給別人聽
   • 教別人如何背
   • 在小組分享

💡 **記憶工具**

• 📱 **手機應用**：設為桌面、提醒
• 📝 **經文卡片**：隨身攜帶
• 🎵 **經文歌曲**：配上旋律
• 📋 **便利貼**：貼在常見的地方
• 📖 **背誦本**：製作個人背誦集

═══════════════════════════════════════════════════
  第五步：複習系統
═══════════════════════════════════════════════════

🔄 **艾賓浩斯遺忘曲線**

根據記憶科學，建議複習時間表：

• **第1次**：背誦後立即複習
• **第2次**：20分鐘後
• **第3次**：1小時後
• **第4次**：當天睡前
• **第5次**：隔天
• **第6次**：第3天
• **第7次**：第7天
• **第8次**：第15天
• **第9次**：第30天
• **第10次**：第60天

📅 **長期複習計劃**

建立個人的背經複習系統：

**每日複習**（5-10分鐘）
• 複習本週新背的經文
• 複習上週的經文
• 抽查一個月前背過的經文

**每週複習**（30分鐘）
• 週末集中複習本月所有經文
• 檢查遺忘的經文，重點加強
• 測試自己，錄音檢驗

**每月複習**（1小時）
• 複習過去三個月的所有經文
• 整理經文卡片，按主題分類
• 與家人或小組彼此背誦

**每季複習**（2小時）
• 全面複習過去的經文
• 總結背經心得
• 設定下一季目標

💡 **防止遺忘的方法**

• 經常在禱告中使用
• 在生活中應用
• 分享給他人
• 寫下應用見證
• 教導他人背誦
• 與主題串連
• 定期測試自己

═══════════════════════════════════════════════════
  📊 背經進度追蹤
═══════════════════════════════════════════════════

請記錄您的背經進度：

**本週目標經文**：
_________________________________________________

**背誦進度**：
□ 第1天：熟悉理解 ✓
□ 第2天：分段記憶
□ 第3天：連貫背誦
□ 第4天：獨立背誦
□ 第5天：流暢背出
□ 第6-7天：鞏固複習

**已掌握經文數**：____ 處

**本月目標**：____ 處

**本年目標**：____ 處

═══════════════════════════════════════════════════
  🎯 背經目標建議
═══════════════════════════════════════════════════

**初學者**（第1年）
• 目標：背誦 20-30 處經文
• 重點：經典金句、常用經文
• 方法：從簡單開始，建立習慣

**進階者**（第2年）
• 目標：背誦 50-100 處經文
• 重點：主題系列、完整段落
• 方法：系統性背誦，深度理解

**資深者**（第3年以上）
• 目標：背誦整卷書或 100+ 經文
• 重點：神學主題、書卷精讀
• 方法：教導他人，活出真理

═══════════════════════════════════════════════════

【工具快速參考】

搜尋經文：
• search_bible - 按主題搜尋經文

查詢經文：
• get_bible_verse - 取得特定經節
• URI: bible://{self.version}/...

原文研究：
• get_word_analysis - 字詞分析
• lookup_strongs - Strong's 字典

查詢註釋：
• get_commentary - 理解經文背景

串珠經文：
• search_bible - 找相關主題經文

═══════════════════════════════════════════════════

💪 背經的益處

"這律法書不可離開你的口，總要晝夜思想，
  好使你謹守遵行這書上所寫的一切話。
  如此，你的道路就可以亨通，凡事順利。"
                        （約書亞記 1:8）

✅ **屬靈益處**
• 更認識神和祂的話
• 在試探中有力量抵擋
• 禱告更有能力和方向
• 靈命成長更穩固
• 與神關係更親密

✅ **實際益處**
• 隨時可以引用神的話
• 安慰鼓勵自己和他人
• 傳福音時有聖經根據
• 做決定時有神的引導
• 培養屬靈的記憶力

═══════════════════════════════════════════════════

🎓 背經小組／挑戰

考慮與他人一起背經：

• 找一個背經夥伴，彼此督促
• 參加教會的背經小組
• 發起 30 天背經挑戰
• 與家人一起背誦
• 在小組分享背經心得

═══════════════════════════════════════════════════
"""
        
        return prompt.strip()
