"""
Advanced Cross Reference Prompt

交叉引用分析對話範本
協助找出與指定經文相關的交叉引用網路
"""

from dataclasses import dataclass
from typing import Optional
from ..base import PromptTemplate


@dataclass
class AdvancedCrossReferencePrompt(PromptTemplate):
    """交叉引用分析對話範本
    
    深入串連相關經文，建立經文網絡。
    支援多層深度追蹤，展現經文之間的關聯。
    
    特色：
    - 1-3 層深度的交叉引用追蹤
    - 智能分類相關經文
    - 關聯強度評估
    - 主題連結分析
    """
    
    def __init__(
        self,
        reference: str = "John 3:16",
        depth: int = 2,
        max_results: int = 20,
        version: str = "unv"
    ):
        """初始化交叉引用分析 Prompt
        
        Args:
            reference: 經文位置（如 "John 3:16" 或 "Romans 8:28"，預設：John 3:16）
            depth: 追蹤深度
                - 1: 直接引用（僅第一層）
                - 2: 間接引用（第二層相關）
                - 3: 主題連結（第三層擴展）
            max_results: 最大結果數量（預設：20，範圍：10-50）
            version: 聖經版本（預設：unv 和合本）
        """
        super().__init__(
            name="advanced_cross_reference",
            description="深入分析經文的交叉引用，建立經文關聯網絡",
            arguments=[
                {"name": "reference", "description": "經文位置", "required": False},
                {"name": "depth", "description": "追蹤深度 (1-3)", "required": False},
                {"name": "max_results", "description": "最大結果數量", "required": False},
                {"name": "version", "description": "聖經版本", "required": False}
            ]
        )
        self.reference = reference
        self.depth = min(max(depth, 1), 3)  # 限制在 1-3
        self.max_results = min(max(max_results, 10), 50)  # 限制在 10-50
        self.version = version
    
    def render(
        self,
        reference: str = None,
        depth: int = None,
        max_results: int = None,
        version: str = None
    ) -> str:
        """渲染交叉引用分析指引
        
        Args:
            reference: 經文位置（可選，使用時覆蓋初始化值）
            depth: 追蹤深度（可選，使用時覆蓋初始化值）
            max_results: 最大結果數量（可選，使用時覆蓋初始化值）
            version: 聖經版本（可選，使用時覆蓋初始化值）
        """
        # 使用傳入的參數或初始化時的值
        if reference is not None:
            self.reference = reference
        if depth is not None:
            self.depth = min(max(depth, 1), 3)
        if max_results is not None:
            self.max_results = min(max(max_results, 10), 50)
        if version is not None:
            self.version = version
        
        depth_info = {
            1: {"name": "直接引用", "desc": "僅顯示第一層直接相關的經文", "expected": "5-10"},
            2: {"name": "間接引用", "desc": "包含第二層間接相關的經文", "expected": "10-20"},
            3: {"name": "主題連結", "desc": "擴展到第三層主題相關經文", "expected": "20+"}
        }
        
        depth_data = depth_info.get(self.depth, depth_info[2])
        
        prompt = f"""
═══════════════════════════════════════════════════
  🔗 交叉引用分析 - FHL Bible MCP Server
═══════════════════════════════════════════════════

歡迎使用交叉引用分析系統！

📍 目標經文：**{self.reference}**
🎯 追蹤深度：**{depth_data['name']}** (第 {self.depth} 層)
📊 最大結果：{self.max_results} 處經文
📚 聖經版本：{self.version.upper()}

【分析說明】
{depth_data['desc']}
預期找到約 {depth_data['expected']} 處相關經文

═══════════════════════════════════════════════════
  步驟 1：取得目標經文 📖
═══════════════════════════════════════════════════

首先，讓我們取得並理解目標經文：

**請執行以下操作**：

方法 A - 如果是單節經文：
```
使用 get_bible_verse 工具
經文：{self.reference}
版本：{self.version}
參數：strong=true（獲取 Strong's Number）
```

方法 B - 如果是範圍經文：
```
使用 get_bible_verses 工具
經文範圍：{self.reference}
版本：{self.version}
```

**或直接使用 URI**：
• bible://verse/{self.version}/{self._format_uri_path()}

【目標經文內容】
（請在此處顯示經文內容）

═══════════════════════════════════════════════════
  步驟 2：第一層 - 直接引用 🎯
═══════════════════════════════════════════════════

【定義】直接引用指：
• 引用相同事件/故事的平行經文
• 新約引用舊約的直接引文
• 同一作者在不同書卷的相同教導
• 明確提到相同人物/地點的經文

【查找方法】：

1️⃣ **關鍵字搜尋**
   提取目標經文的 2-3 個關鍵詞，使用 search_bible：
   
   ```
   關鍵詞 1: [從經文中提取]
   關鍵詞 2: [從經文中提取]
   關鍵詞 3: [從經文中提取]
   
   使用 search_bible 搜尋各關鍵詞
   限制結果：{min(10, self.max_results)} 個
   ```

2️⃣ **原文字詞追蹤**（如果有 Strong's Number）
   
   使用 search_strongs_occurrences 工具：
   ```
   Testament: [從經文判斷 OT/NT]
   Strong's Number: [從步驟 1 獲得]
   限制結果：{min(15, self.max_results)} 個
   ```

3️⃣ **主題標記查詢**
   
   使用 info://topics 查詢相關主題：
   ```
   如果目標經文屬於某個主題（如「救恩」「愛」「信心」）
   使用 search_bible 搜尋該主題的其他經文
   ```

【第一層結果整理】

請將找到的經文按以下格式整理：

```
┌─────────────────────────────────────────────┐
│ 第一層：直接引用（預期 5-10 處）              │
└─────────────────────────────────────────────┘

📌 **類別 A：平行經文**（相同事件的不同記載）
   1. [經文位置] - [簡要說明]
      關聯度：⭐⭐⭐⭐⭐（非常高）
      連結：bible://...
   
   2. ...

📌 **類別 B：引用關係**（新約引用舊約）
   1. [經文位置] - [簡要說明]
      關聯度：⭐⭐⭐⭐（高）
      連結：bible://...

📌 **類別 C：主題相同**（教導相同真理）
   1. [經文位置] - [簡要說明]
      關聯度：⭐⭐⭐（中）
      連結：bible://...
```

═══════════════════════════════════════════════════
  步驟 3：第二層 - 間接引用 🔄
═══════════════════════════════════════════════════
{"" if self.depth < 2 else self._render_depth_2()}

═══════════════════════════════════════════════════
  步驟 4：第三層 - 主題連結 🌐
═══════════════════════════════════════════════════
{"" if self.depth < 3 else self._render_depth_3()}

═══════════════════════════════════════════════════
  步驟 5：關聯網絡視覺化 📊
═══════════════════════════════════════════════════

【經文關聯圖】

請將找到的交叉引用整理成網絡結構：

```
                    🎯 目標經文
                    {self.reference}
                         │
        ┌────────────────┼────────────────┐
        │                │                │
     📌 類別A         📌 類別B         📌 類別C
    (平行經文)       (引用關係)       (主題相同)
        │                │                │
    [經文1]          [經文3]          [經文5]
    [經文2]          [經文4]          [經文6]
{"        │                │                │" if self.depth >= 2 else ""}
{"    [第二層...]      [第二層...]      [第二層...]" if self.depth >= 2 else ""}
{"        │                │                │" if self.depth >= 3 else ""}
{"    [第三層...]      [第三層...]      [第三層...]" if self.depth >= 3 else ""}
```

【關聯強度分析】

統計各層級的經文數量：

• 第一層（直接引用）：__ 處
  - 平行經文：__ 處（⭐⭐⭐⭐⭐）
  - 引用關係：__ 處（⭐⭐⭐⭐）
  - 主題相同：__ 處（⭐⭐⭐）
{"" if self.depth < 2 else '''
• 第二層（間接引用）：__ 處
  - 主題延伸：__ 處（⭐⭐）
  - 概念相關：__ 處（⭐⭐）
'''}
{"" if self.depth < 3 else '''
• 第三層（主題連結）：__ 處
  - 廣義主題：__ 處（⭐）
'''}

總計：__ 處相關經文（限制：{self.max_results} 處）

═══════════════════════════════════════════════════
  步驟 6：關聯分析報告 📝
═══════════════════════════════════════════════════

【核心主題識別】

根據交叉引用網絡，目標經文 {self.reference} 的核心主題：

1. **主要主題**：[從經文內容和交叉引用中歸納]
   • 相關經文數量：__ 處
   • 約別分布：舊約 __ 處 / 新約 __ 處
   • 重點書卷：[列出出現最多的 3 個書卷]

2. **次要主題**：[相關但不是核心的主題]
   • 相關經文數量：__ 處

3. **延伸主題**：[第三層發現的廣泛主題]
   • 相關經文數量：__ 處

【神學脈絡】

從交叉引用網絡看該經文的神學意義：

• **在舊約中的根源**：
  [如果有舊約相關經文，說明舊約如何預表或預言]

• **在新約中的成全**：
  [如果有新約相關經文，說明新約如何應驗或實現]

• **在救恩歷史中的位置**：
  創造 → 墮落 → 應許 → 預表 → 道成肉身 → 救贖 → 聖靈降臨 → 成聖 → 再來 → 新天新地
  [標示該經文在哪個階段]

【實用建議】

💡 **講道/教學使用**：
• 可以串講的經文組合：[建議 3-5 處經文]
• 對比教學的經文對：[新舊約對比或不同角度對比]
• 主題查經建議：[如何使用這些交叉引用進行主題查經]

💡 **個人研經使用**：
• 優先研讀的經文：[關聯度最高的 3-5 處]
• 背誦串聯：[可以一起背誦的經文組]
• 默想方向：[從交叉引用中發現的默想角度]

═══════════════════════════════════════════════════
  步驟 7：進階探索建議 🚀
═══════════════════════════════════════════════════

【如果想要更深入研究】：

1. **深入特定相關經文**
   選擇關聯度最高的經文，使用 study_verse_deep：
   ```
   對於 [相關經文位置]
   使用 study_verse_deep prompt 進行深入研讀
   ```

2. **比較不同譯本**
   使用 study_translation_compare：
   ```
   比較 {self.reference} 在不同譯本中的翻譯
   了解翻譯差異如何影響理解
   ```

3. **原文字詞研究**
   使用 study_word_original：
   ```
   研究關鍵字詞的希伯來文/希臘文原意
   更準確理解經文含義
   ```

4. **主題串連研究**
   使用 special_topical_chain：
   ```
   追蹤核心主題在全聖經中的發展
   建立更完整的神學理解
   ```

5. **擴展到更高層級**（如果當前深度 < 3）
   重新運行本 prompt，增加深度參數：
   ```
   depth={self.depth + 1} （當前：{self.depth}）
   探索更廣泛的主題連結
   ```

═══════════════════════════════════════════════════
  完成！✅
═══════════════════════════════════════════════════

【本次分析摘要】

📍 目標經文：{self.reference}
🎯 追蹤深度：第 {self.depth} 層
📊 找到經文：__ 處（限制：{self.max_results}）
⏱️ 分析時間：[記錄完成時間]

【快速導航】

• 查看所有結果的完整列表
• 按關聯度排序
• 按書卷分類
• 按約別分類（舊約/新約）
• 匯出為文字檔案

【需要幫助？】
• 使用 help_guide 查看完整功能
• 使用 tool_reference 查看工具說明
• 調整 depth 或 max_results 參數重新分析

═══════════════════════════════════════════════════
"""
        return prompt.strip()
    
    def _format_uri_path(self) -> str:
        """格式化 URI 路徑"""
        # 簡單解析經文位置
        # 格式如：John 3:16 → John/3/16
        parts = self.reference.replace(":", "/").split()
        if len(parts) >= 2:
            return "/".join(parts)
        return self.reference.replace(" ", "/")
    
    def _render_depth_2(self) -> str:
        """渲染第二層內容"""
        return """
【定義】間接引用指：
• 與第一層經文相關的其他經文
• 主題延伸的經文
• 概念相關但不直接引用的經文
• 同一神學主題的不同角度

【查找方法】：

1️⃣ **從第一層經文擴展**
   
   對於第一層找到的重要經文，再次進行關鍵字搜尋：
   ```
   選擇第一層中關聯度最高的 3-5 處經文
   提取它們的關鍵詞
   使用 search_bible 搜尋
   排除已在第一層出現的經文
   ```

2️⃣ **主題擴展搜尋**
   
   識別第一層經文的共同主題，搜尋該主題：
   ```
   主題關鍵詞：[從第一層歸納]
   使用 search_bible 搜尋主題相關經文
   限制結果：{min(10, self.max_results - 10)} 個
   ```

3️⃣ **書卷系統搜尋**
   
   如果發現某書卷經常出現，查看該書卷的相關章節：
   ```
   重點書卷：[統計第一層結果]
   使用 get_bible_chapter 閱讀相關章節
   識別間接相關的經文
   ```

【第二層結果整理】

```
┌─────────────────────────────────────────────┐
│ 第二層：間接引用（預期 5-10 處）              │
└─────────────────────────────────────────────┘

📌 **類別 D：主題延伸**（延伸相同主題）
   1. [經文位置] - [簡要說明]
      關聯度：⭐⭐（中低）
      連結：bible://...
      來源：從 [第一層經文] 延伸

📌 **類別 E：概念相關**（相關概念）
   1. [經文位置] - [簡要說明]
      關聯度：⭐⭐（中低）
      連結：bible://...
      來源：與 [主題] 概念相關
```
"""
    
    def _render_depth_3(self) -> str:
        """渲染第三層內容"""
        return """
【定義】主題連結指：
• 廣義主題相關的經文
• 神學概念相關但距離較遠
• 應用層面的相關經文
• 屬靈原則的延伸

【查找方法】：

1️⃣ **廣義主題搜尋**
   
   擴展到更廣泛的主題領域：
   ```
   核心主題：[從第一、二層歸納]
   相關主題：[列出 2-3 個相關主題]
   使用 search_bible 搜尋各相關主題
   限制結果：{min(10, self.max_results - 20)} 個
   ```

2️⃣ **神學連結**
   
   尋找相同神學原則的其他經文：
   ```
   神學原則：[歸納經文的核心原則]
   搜尋體現相同原則的經文
   可能跨越不同具體主題
   ```

3️⃣ **應用層面連結**
   
   尋找有相似應用的經文：
   ```
   實際應用：[該經文的生活應用]
   搜尋有相似應用建議的經文
   可能來自完全不同的背景
   ```

【第三層結果整理】

```
┌─────────────────────────────────────────────┐
│ 第三層：主題連結（預期 5-10 處）              │
└─────────────────────────────────────────────┘

📌 **類別 F：廣義主題**（廣泛相關主題）
   1. [經文位置] - [簡要說明]
      關聯度：⭐（低）
      連結：bible://...
      來源：廣義 [主題] 相關

📌 **類別 G：應用相關**（類似應用）
   1. [經文位置] - [簡要說明]
      關聯度：⭐（低）
      連結：bible://...
      來源：應用層面相關
```
"""
