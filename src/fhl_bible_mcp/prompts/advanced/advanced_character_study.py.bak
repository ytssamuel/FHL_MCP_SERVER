"""
Advanced Character Study Prompt

聖經人物研究對話範本
全面研究聖經中的人物，包含生平、性格、事蹟、屬靈教訓
"""

from dataclasses import dataclass
from typing import Optional
from ..base import PromptTemplate


@dataclass
class AdvancedCharacterStudyPrompt(PromptTemplate):
    """聖經人物研究對話範本
    
    全面研究聖經人物的生平、性格、事蹟和屬靈教訓。
    適用於個人靈修、主日學教學、講道準備。
    
    特色：
    - 系統化的人物分析框架
    - 經文定位和背景資料
    - 性格優缺點剖析
    - 屬靈教訓和現代應用
    """
    
    def __init__(
        self,
        character: str = "Peter",
        focus: str = "all",
        testament: str = "both",
        version: str = "unv"
    ):
        """初始化聖經人物研究 Prompt
        
        Args:
            character: 人物名稱（如 "Peter", "Paul", "David"，預設：Peter）
                      支援中英文：「彼得」「保羅」「大衛」等
            focus: 研究焦點
                - all: 全面研究（生平+性格+教訓）
                - biography: 生平事蹟為主
                - character: 性格分析為主
                - lessons: 屬靈教訓為主
            testament: 約別限制
                - OT: 僅舊約人物
                - NT: 僅新約人物
                - both: 新舊約都查（如果人物跨約）
            version: 聖經版本（預設：unv 和合本）
        """
        super().__init__(
            name="advanced_character_study",
            description="全面研究聖經人物，包含生平、性格、事蹟、屬靈教訓",
            arguments=[
                {"name": "character", "description": "人物名稱", "required": False},
                {"name": "focus", "description": "研究焦點 (all/biography/character/lessons)", "required": False},
                {"name": "testament", "description": "約別限制 (OT/NT/both)", "required": False},
                {"name": "version", "description": "聖經版本", "required": False}
            ]
        )
        self.character = character
        self.focus = focus
        self.testament = testament
        self.version = version
    
    def render(
        self,
        character: str = None,
        focus: str = None,
        testament: str = None,
        version: str = None
    ) -> str:
        """渲染聖經人物研究指引
        
        Args:
            character: 人物名稱（可選，使用時覆蓋初始化值）
            focus: 研究焦點（可選，使用時覆蓋初始化值）
            testament: 約別限制（可選，使用時覆蓋初始化值）
            version: 聖經版本（可選，使用時覆蓋初始化值）
        """
        # 使用傳入的參數或初始化時的值
        if character is not None:
            self.character = character
        if focus is not None:
            self.focus = focus
        if testament is not None:
            self.testament = testament
        if version is not None:
            self.version = version
        
        focus_info = {
            "all": {"name": "全面研究", "sections": "生平事蹟 + 性格分析 + 屬靈教訓"},
            "biography": {"name": "生平事蹟", "sections": "重點：時間線、重要事件、關係網絡"},
            "character": {"name": "性格分析", "sections": "重點：優點缺點、成長軌跡、情感世界"},
            "lessons": {"name": "屬靈教訓", "sections": "重點：信仰功課、現代應用、警惕教訓"}
        }
        
        testament_info = {
            "OT": "舊約聖經",
            "NT": "新約聖經",
            "both": "新舊約全書"
        }
        
        focus_data = focus_info.get(self.focus, focus_info["all"])
        testament_name = testament_info.get(self.testament, "新舊約全書")
        
        prompt = f"""
═══════════════════════════════════════════════════
  👤 聖經人物研究 - FHL Bible MCP Server
═══════════════════════════════════════════════════

歡迎使用聖經人物研究系統！

👤 研究人物：**{self.character}**
🎯 研究焦點：**{focus_data['name']}**
📖 研究範圍：{testament_name}
📚 聖經版本：{self.version.upper()}

【研究架構】
{focus_data['sections']}

═══════════════════════════════════════════════════
  步驟 1：人物基本資料 📋
═══════════════════════════════════════════════════

【使用 search_bible 定位人物】

搜尋該人物在聖經中的所有出現：

```
使用 search_bible 工具
關鍵詞：{self.character}（及其變體、別名）
{"約別限制：" + ("舊約" if self.testament == "OT" else "新約" if self.testament == "NT" else "不限") if self.testament != "both" else ""}
記錄所有提及該人物的經文
```

【基本資料卡】

請整理該人物的基本資訊：

```
┌─────────────────────────────────────────────┐
│ {self.character} 基本資料                    │
└─────────────────────────────────────────────┘

📛 名字：{self.character}
   • 原文名稱：[希伯來文/希臘文]
   • 名字意義：[使用 lookup_strongs 查詢]
   • 別名/別稱：[如果有]

📍 時代背景：
   • 生活年代：約 [時間]
   • 歷史時期：[如士師時代、王國時期、使徒時代等]
   • 地理位置：[主要活動地區]

👨‍👩‍👧‍👦 家庭關係：
   • 父母：[名字]
   • 配偶：[名字]
   • 子女：[名字]
   • 其他親屬：[重要親屬]

💼 身份職業：
   • 主要身份：[如先知、使徒、君王等]
   • 職業：[如果有特定職業]
   • 部族/家族：[如利未支派、便雅憫支派等]

📊 聖經記載統計：
   • 首次出現：[書卷章節]
   • 最後出現：[書卷章節]
   • 提及次數：約 __ 次
   • 主要記載：[列出 3-5 個主要章節]
```

【快速導航 - 重要經文】

請列出該人物最重要的 5-10 段經文：

1. [書卷 章:節] - [事件簡述]
   URI: bible://verse/{self.version}/[book]/[chapter]/[verse]

2. [書卷 章:節] - [事件簡述]
   URI: bible://verse/{self.version}/[book]/[chapter]/[verse]

（繼續列出...）

═══════════════════════════════════════════════════
  步驟 2：生平事蹟時間線 ⏳
═══════════════════════════════════════════════════
{self._render_biography_section() if self.focus in ["all", "biography"] else "（本次研究焦點不包含生平事蹟，如需要請調整 focus 參數）"}

═══════════════════════════════════════════════════
  步驟 3：性格特質分析 🎭
═══════════════════════════════════════════════════
{self._render_character_section() if self.focus in ["all", "character"] else "（本次研究焦點不包含性格分析，如需要請調整 focus 參數）"}

═══════════════════════════════════════════════════
  步驟 4：屬靈教訓與應用 💎
═══════════════════════════════════════════════════
{self._render_lessons_section() if self.focus in ["all", "lessons"] else "（本次研究焦點不包含屬靈教訓，如需要請調整 focus 參數）"}

═══════════════════════════════════════════════════
  步驟 5：關係網絡圖 🕸️
═══════════════════════════════════════════════════

【人物關係視覺化】

繪製該人物的重要關係網絡：

```
                    👤 {self.character}
                         │
        ┌────────────────┼────────────────┐
        │                │                │
     👨‍👩‍👧‍👦 家庭         👥 師徒          ⚔️ 敵對
        │                │                │
    [家人1]          [導師/學生]        [敵人/對手]
    [家人2]          [同工/夥伴]        [衝突對象]
        │                │                │
    [關係說明]        [關係說明]        [關係說明]
```

【關鍵關係深入分析】

選擇 3-5 個最重要的關係進行深入分析：

1️⃣ **與 [人物 A] 的關係**
   
   • 關係性質：[師徒/夫妻/朋友/敵對等]
   • 重要事件：
     - [事件 1]（經文：[章節]）
     - [事件 2]（經文：[章節]）
   • 關係對兩人的影響：
     - 對 {self.character}：[影響說明]
     - 對 [人物 A]：[影響說明]
   • 屬靈教訓：[從這關係學到什麼]

2️⃣ **與 [人物 B] 的關係**
   （同上格式）

═══════════════════════════════════════════════════
  步驟 6：聖經作者的評價 ✍️
═══════════════════════════════════════════════════

【聖經對該人物的評論】

搜尋聖經中對該人物的直接評價：

**正面評價**
```
1. 「[引用經文中的評價]」
   出處：[書卷 章:節]
   說明：[這評價的背景和意義]

2. ...
```

**負面評價/批評**
```
1. 「[引用經文中的批評]」
   出處：[書卷 章:節]
   說明：[這批評的背景和意義]

2. ...
```

**後世的見證**（如果有）
```
如新約提及舊約人物：
1. 「[引用經文]」
   出處：[書卷 章:節]
   說明：[後世如何看待這人物]
```

【信心英雄榜】（希伯來書 11 章）
```
{"✓ " if self.character in ["Abel", "Enoch", "Noah", "Abraham", "Sarah", "Isaac", "Jacob", "Joseph", "Moses", "Rahab", "Gideon", "Barak", "Samson", "Jephthah", "David", "Samuel"] else "✗ "}是否列在希伯來書 11 章信心英雄榜中
{"如果是，引用相關經節：" if self.character in ["Abel", "Enoch", "Noah", "Abraham", "Sarah", "Isaac", "Jacob", "Joseph", "Moses", "Rahab", "Gideon", "Barak", "Samson", "Jephthah", "David", "Samuel"] else ""}
{"來 11:__ - 「[經文內容]」" if self.character in ["Abel", "Enoch", "Noah", "Abraham", "Sarah", "Isaac", "Jacob", "Joseph", "Moses", "Rahab", "Gideon", "Barak", "Samson", "Jephthah", "David", "Samuel"] else ""}
```

═══════════════════════════════════════════════════
  步驟 7：主題式研究建議 📚
═══════════════════════════════════════════════════

【延伸研究主題】

根據該人物的特點，建議以下主題式研究：

1. **信心之旅**
   ```
   追蹤 {self.character} 信心的成長軌跡
   關鍵經文：[列出 3-5 處展現信心的經文]
   使用 special_topical_chain 深入研究「信心」主題
   ```

2. **領導力研究**（如適用）
   ```
   分析 {self.character} 的領導風格和決策
   關鍵經文：[列出領導相關經文]
   對比其他聖經領袖（如摩西、約書亞、保羅等）
   ```

3. **失敗與恢復**（如適用）
   ```
   研究 {self.character} 的跌倒和復興
   關鍵經文：[列出相關經文]
   學習神如何恢復、使用軟弱的人
   ```

4. **禱告生活**（如適用）
   ```
   收集 {self.character} 的禱告記錄
   分析禱告內容和蒙應允的過程
   學習有效的禱告模式
   ```

5. **與神關係**
   ```
   追蹤 {self.character} 與神關係的發展
   關鍵經文：[列出遇見神、聽神聲音的經文]
   學習親近神的秘訣
   ```

═══════════════════════════════════════════════════
  步驟 8：應用與反思 💭
═══════════════════════════════════════════════════

【現代應用問題】

請根據研究內容，思考以下問題：

**個人層面**
1. {self.character} 的哪些特質值得我學習？
2. {self.character} 的哪些軟弱警惕我避免？
3. 我的生命中有類似 {self.character} 的經歷嗎？
4. 神在 {self.character} 生命中的作為，如何鼓勵我？
5. 我可以從 {self.character} 身上學到什麼具體行動？

**關係層面**
1. {self.character} 如何處理人際關係？我可以學習什麼？
2. {self.character} 與神的關係給我什麼啟發？
3. 我是否需要修復某些關係，如同 {self.character} 一樣？

**服事層面**
1. {self.character} 如何回應神的呼召？
2. {self.character} 如何面對服事中的挑戰？
3. 我的恩賜和呼召與 {self.character} 有何相似之處？
4. 我可以如何在我的處境中服事神？

【行動計劃】

根據本次研究，制定具體的行動計劃：

```
┌─────────────────────────────────────────────┐
│ 從 {self.character} 學習的行動計劃           │
└─────────────────────────────────────────────┘

📅 本週行動：
   □ [具體行動 1]
   □ [具體行動 2]
   □ [具體行動 3]

📖 背誦經文：
   選擇一節關於 {self.character} 的經文背誦
   推薦：[書卷 章:節]

🙏 禱告方向：
   • 為自己：[禱告重點]
   • 為教會：[禱告重點]
   • 為世界：[禱告重點]

📝 分享計劃：
   如何與小組/家人分享本次研究的收穫
```

═══════════════════════════════════════════════════
  步驟 9：教學/講道資源 🎤
═══════════════════════════════════════════════════

【如果要教導或講道】

提供教學/講道的建議結構：

**主題式講道大綱**

```
講題：「從 {self.character} 看 [核心主題]」

引言：
• 生活中的相關情境
• 引出 {self.character} 的故事

本論：
I. {self.character} 的背景（步驟 1）
   A. 時代處境
   B. 面對的挑戰

II. {self.character} 的選擇（步驟 2-3）
   A. 關鍵決定
   B. 背後的信念

III. 神的作為（步驟 4）
   A. 神如何引導
   B. 神如何使用

結論：
• 對我們的啟示（步驟 8）
• 具體行動呼召

例證：
• [現代例證 1]
• [歷史例證 2]
```

**系列講道建議**（適合深入研究）

```
第一講：認識 {self.character}（背景與早年）
第二講：{self.character} 的信心（重要事蹟）
第三講：{self.character} 的軟弱（失敗與學習）
第四講：{self.character} 的復興（神的恢復）
第五講：{self.character} 的遺產（影響與教訓）
```

**小組查經材料**

```
查經經文：[選擇 1-2 章重要經文]

破冰問題：
1. 你對 {self.character} 的第一印象是什麼？

觀察問題：
1. 這段經文記載了什麼事件？
2. {self.character} 在事件中做了什麼？
3. 其他人有什麼反應？

解釋問題：
1. 為什麼 {self.character} 這樣做？
2. 這事件對 {self.character} 有什麼影響？
3. 神在這事件中扮演什麼角色？

應用問題：
1. 這對我們有什麼啟發？
2. 我們可以學習什麼？
3. 本週如何實踐？

禱告：
為應用事項彼此代禱
```

═══════════════════════════════════════════════════
  完成！✅
═══════════════════════════════════════════════════

【研究成果摘要】

👤 研究人物：{self.character}
🎯 研究焦點：{focus_data['name']}
📊 涵蓋範圍：
   • 基本資料：✓
   {"• 生平事蹟：✓" if self.focus in ["all", "biography"] else "• 生平事蹟：✗（焦點未包含）"}
   {"• 性格分析：✓" if self.focus in ["all", "character"] else "• 性格分析：✗（焦點未包含）"}
   {"• 屬靈教訓：✓" if self.focus in ["all", "lessons"] else "• 屬靈教訓：✗（焦點未包含）"}
   • 關係網絡：✓
   • 聖經評價：✓
   • 主題研究：✓
   • 現代應用：✓
   • 教學資源：✓

⏱️ 完成時間：[記錄完成時間]

【核心收穫】

• 最重要的發現：[總結 1-2 個關鍵洞察]
• 最大的挑戰：[對自己的挑戰]
• 最寶貴的應用：[具體行動]

【進階研究建議】

• 使用 study_verse_deep 深入研讀關鍵經節
• 使用 advanced_cross_reference 找出相關經文網絡
• 使用 special_topical_chain 追蹤相關主題
• 研究與 {self.character} 相關的其他人物

【需要幫助？】
• 使用 help_guide 查看完整功能
• 使用 tool_reference 查看工具說明
• 調整 focus 參數進行不同焦點的研究

═══════════════════════════════════════════════════
"""
        return prompt.strip()
    
    def _render_biography_section(self) -> str:
        """渲染生平事蹟章節"""
        return f"""
【使用 search_bible 和 get_bible_verses 構建時間線】

請按時間順序整理 {self.character} 的生平：

**階段一：早年 / 出場**

```
時期：[年齡或時間點]
主要事件：
1. [事件名稱]
   • 經文：[書卷 章:節]
   • 內容摘要：[簡述事件]
   • 關鍵學習：[這事件的意義]
   • URI: bible://verse/{self.version}/[book]/[chapter]/[verse]

2. [事件名稱]
   （同上格式）
```

**階段二：成長 / 呼召**

```
時期：[年齡或時間點]
主要事件：
1. [事件名稱]
   • 經文：[書卷 章:節]
   • 內容摘要：[簡述事件]
   • 神的介入：[神如何引導或介入]
   • 人物回應：[{self.character} 如何回應]
   • URI: bible://verse/{self.version}/[book]/[chapter]/[verse]

2. [事件名稱]
   （同上格式）
```

**階段三：服事高峰**

```
時期：[年齡或時間點]
主要事件：
1. [事件名稱]
   • 經文：[書卷 章:節]
   • 內容摘要：[簡述事件]
   • 成就/影響：[對他人或國家的影響]
   • URI: bible://verse/{self.version}/[book]/[chapter]/[verse]

2. [事件名稱]
   （同上格式）
```

**階段四：挑戰 / 試煉**（如有）

```
時期：[年齡或時間點]
主要事件：
1. [事件名稱]
   • 經文：[書卷 章:節]
   • 內容摘要：[簡述挑戰或失敗]
   • 原因分析：[為何會失敗]
   • 後果：[失敗的影響]
   • URI: bible://verse/{self.version}/[book]/[chapter]/[verse]

2. [事件名稱]
   （同上格式）
```

**階段五：晚年 / 結局**

```
時期：[年齡或時間點]
主要事件：
1. [事件名稱]
   • 經文：[書卷 章:節]
   • 內容摘要：[晚年的重要事蹟]
   • 遺言/遺產：[留下的教導或影響]
   • URI: bible://verse/{self.version}/[book]/[chapter]/[verse]

2. 去世/結局
   • 經文：[書卷 章:節]
   • 享年：[年齡]
   • 聖經評價：[聖經如何總結這人的一生]
```

【生平時間線視覺化】

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  {self.character} 的生命歷程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[時間點1]  [時間點2]  [時間點3]  [時間點4]  [時間點5]
    │          │          │          │          │
 [事件1]    [事件2]    [事件3]    [事件4]    [事件5]
    │          │          │          │          │
 [階段1]    [階段2]    [階段3]    [階段4]    [階段5]
  早年       呼召       高峰       試煉       晚年
    │          │          │          │          │
━━━━┿━━━━━━━━┿━━━━━━━━┿━━━━━━━━┿━━━━━━━━┿━━
    │          │          │          │          │
[學習1]    [學習2]    [學習3]    [學習4]    [學習5]
```

【重要轉折點】

識別 {self.character} 生命中的 3-5 個重要轉折點：

1. **[轉折點 1]**（約 [時間]）
   • 發生什麼：[簡述事件]
   • 為何重要：[這轉折的意義]
   • 經文：[書卷 章:節]
   • 對後續影響：[如何影響之後的人生]

2. **[轉折點 2]**
   （同上格式）
"""
    
    def _render_character_section(self) -> str:
        """渲染性格分析章節"""
        return f"""
【從經文中歸納性格特質】

基於 {self.character} 的言行舉止，分析其性格：

**【優點/美德】**

1. **[特質 1]**（如：信心、勇氣、謙卑等）
   
   • 經文證據：
     - [書卷 章:節]：「[引用展現此特質的經文片段]」
     - [書卷 章:節]：「[另一個例子]」
   
   • 具體表現：
     [描述如何在具體情境中展現此特質]
   
   • 對我們的啟發：
     [我們如何培養這樣的特質]

2. **[特質 2]**
   （同上格式）

3. **[特質 3]**
   （同上格式）

**【弱點/軟弱】**

1. **[弱點 1]**（如：衝動、驕傲、懼怕等）
   
   • 經文證據：
     - [書卷 章:節]：「[引用展現此弱點的經文片段]」
     - [書卷 章:節]：「[另一個例子]」
   
   • 造成的後果：
     [這弱點帶來什麼負面影響]
   
   • 對我們的警惕：
     [我們如何避免同樣的軟弱]

2. **[弱點 2]**
   （同上格式）

**【性格發展軌跡】**

追蹤 {self.character} 性格的成長變化：

```
早期特徵 ────> 中期變化 ────> 成熟特徵

[早期性格]      [經歷]        [成熟性格]
 例：衝動    ──> 試煉/教導 ──>  穩重
     │             │             │
  [經文]        [經文]        [經文]
```

【情感世界】

分析 {self.character} 的情感表達：

• **喜樂時刻**：
  [何時最喜樂] - 經文：[章節]

• **憂傷時刻**：
  [何時最憂傷] - 經文：[章節]

• **憤怒時刻**：
  [何時發怒] - 經文：[章節]
  [憤怒是否正當]

• **恐懼時刻**：
  [何時害怕] - 經文：[章節]
  [如何克服]

• **愛的表達**：
  [如何表達對神、對人的愛] - 經文：[章節]

【性格特質總結圖】

```
┌─────────────────────────────────────────────┐
│ {self.character} 性格特質雷達圖               │
└─────────────────────────────────────────────┘

        信心 ⭐⭐⭐⭐⭐
         │
    勇氣 │  謙卑
  ⭐⭐⭐⭐│⭐⭐⭐⭐⭐
         │
    ────{self.character}────
         │
  ⭐⭐⭐⭐│⭐⭐⭐⭐
    智慧 │  愛心
         │
        忍耐 ⭐⭐⭐⭐

（根據經文表現評估，滿分 5 星）
```
"""
    
    def _render_lessons_section(self) -> str:
        """渲染屬靈教訓章節"""
        return f"""
【從 {self.character} 學習的屬靈功課】

**【正面榜樣】**

從 {self.character} 的優點學習：

1. **關於信心**
   
   • 經文示範：
     [書卷 章:節] - [{self.character} 如何展現信心]
   
   • 神學原則：
     [從這例子看到的信心原則]
   
   • 實際應用：
     今天我們如何實踐：
     - [應用 1]
     - [應用 2]
     - [應用 3]

2. **關於順服**（或其他主題）
   
   • 經文示範：
     [書卷 章:節] - [{self.character} 如何順服神]
   
   • 神學原則：
     [從這例子看到的順服原則]
   
   • 實際應用：
     今天我們如何實踐：
     - [應用 1]
     - [應用 2]

3. **關於 [其他主題]**
   （同上格式）

**【負面警惕】**

從 {self.character} 的失敗學習：

1. **關於 [弱點主題]**
   
   • 失敗事件：
     [書卷 章:節] - [{self.character} 如何跌倒]
   
   • 失敗原因：
     - 遠因：[長期的問題]
     - 近因：[直接觸發的因素]
   
   • 後果影響：
     - 對自己：[個人後果]
     - 對家庭：[家庭影響]
     - 對國家/教會：[更廣泛影響]
   
   • 警惕教訓：
     今天我們如何避免：
     - [警惕 1]
     - [警惕 2]
     - [警惕 3]

2. **關於 [另一個弱點]**
   （同上格式）

**【神的恩典】**

從神如何對待 {self.character} 學習：

• **神的呼召**
  經文：[章節]
  神如何呼召：[描述]
  對我們的意義：[我們如何回應神的呼召]

• **神的管教**（如適用）
  經文：[章節]
  神如何管教：[描述]
  管教的目的：[為何管教]
  管教後的恢復：[如何恢復]
  對我們的意義：[如何看待神的管教]

• **神的使用**
  經文：[章節]
  神如何使用：[描述神如何用他]
  對我們的意義：[神也要使用我們]

• **神的堅固**
  經文：[章節]
  神如何堅固：[在軟弱中神的扶持]
  對我們的意義：[神不撇棄軟弱的人]

**【核心教訓總結】**

{self.character} 的一生教導我們：

1. **關於神的性情**：
   從神對 {self.character} 的作為，我們認識到神是：
   • [屬性 1]：[說明]
   • [屬性 2]：[說明]
   • [屬性 3]：[說明]

2. **關於人的責任**：
   {self.character} 的一生提醒我們：
   • [責任 1]：[說明]
   • [責任 2]：[說明]
   • [責任 3]：[說明]

3. **關於得勝的秘訣**：
   {self.character} 得勝的關鍵在於：
   • [秘訣 1]：[說明]
   • [秘訣 2]：[說明]
   • [秘訣 3]：[說明]

【金句精選】

從 {self.character} 的記載中，選出 3-5 節值得背誦的金句：

1. [書卷 章:節]
   「[經文內容]」
   
   為何重要：[這節經文的意義]
   背誦建議：使用 special_memory_verse 幫助背誦

2. [書卷 章:節]
   （同上格式）
"""
